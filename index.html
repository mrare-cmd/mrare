<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TOPA Pipeline Dashboard</title>
<!-- Proxima Nova via Adobe Fonts fallback chain; system fallback to Nunito which is close -->
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
/* ‚îÄ‚îÄ Proxima Nova stack: load via @font-face if available, else Nunito ‚îÄ‚îÄ */
@font-face {
  font-family: 'Proxima Nova';
  src: local('Proxima Nova'), local('ProximaNova-Regular');
  font-weight: 400;
}
@font-face {
  font-family: 'Proxima Nova';
  src: local('Proxima Nova Semibold'), local('ProximaNova-Semibold');
  font-weight: 600;
}
@font-face {
  font-family: 'Proxima Nova';
  src: local('Proxima Nova Bold'), local('ProximaNova-Bold');
  font-weight: 700;
}
@font-face {
  font-family: 'Proxima Nova';
  src: local('Proxima Nova Extrabold'), local('ProximaNova-Extrabold');
  font-weight: 800;
}

:root {
  --navy: #081937;
  --navy-mid: #0d2548;
  --navy-light: #1a3a6b;
  --navy-border: rgba(255,255,255,0.1);
  --white: #ffffff;
  --off-white: #f4f6f9;
  --border: #e2e8f0;
  --muted: #64748b;
  --green: #16a34a;
  --green-bg: #dcfce7;
  --red: #dc2626;
  --red-bg: #fee2e2;
  --gray: #94a3b8;
  --gray-bg: #f1f5f9;
  --accent: #2563eb;
  --gold: #d97706;
  --font: 'Proxima Nova', 'Nunito', sans-serif;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; }
body { font-family: var(--font); background: var(--off-white); color: var(--navy); display: flex; flex-direction: column; font-size: 13px; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
header {
  background: var(--navy);
  color: var(--white);
  height: 58px;
  padding: 0 24px;
  display: flex;
  align-items: center;
  gap: 0;
  border-bottom: 1px solid var(--navy-light);
  flex-shrink: 0;
}
.hdr-brand {
  display: flex; flex-direction: column; justify-content: center;
  border-right: 1px solid var(--navy-border);
  padding-right: 20px; margin-right: 20px; height: 100%;
}
.hdr-brand h1 { font-size: 1.15rem; font-weight: 800; color: var(--white); letter-spacing: 0.01em; line-height: 1; }
.hdr-brand .sub { font-size: 0.6rem; color: rgba(255,255,255,0.4); letter-spacing: 0.12em; text-transform: uppercase; margin-top: 3px; }

.hdr-asof { display: flex; flex-direction: column; justify-content: center; }
.hdr-asof .asof-lbl { font-size: 0.58rem; color: rgba(255,255,255,0.38); letter-spacing: 0.12em; text-transform: uppercase; }
.hdr-asof .asof-val { font-size: 1.05rem; font-weight: 700; color: var(--white); margin-top: 1px; }

.hdr-stats { display: flex; gap: 0; margin-left: auto; height: 100%; }
.stat-blk {
  display: flex; flex-direction: column; justify-content: center; align-items: flex-end;
  padding: 0 18px; border-left: 1px solid var(--navy-border);
}
.stat-blk .v { font-size: 1.05rem; font-weight: 700; color: var(--white); line-height: 1; }
.stat-blk .l { font-size: 0.57rem; color: rgba(255,255,255,0.38); letter-spacing: 0.1em; text-transform: uppercase; margin-top: 3px; }

.hdr-btns { display: flex; gap: 8px; margin-left: 16px; align-items: center; }
.hdr-btn {
  padding: 7px 14px; border: 1.5px solid rgba(255,255,255,0.25); color: rgba(255,255,255,0.7);
  background: rgba(255,255,255,0.07); font-family: var(--font); font-size: 0.68rem; font-weight: 600;
  cursor: pointer; border-radius: 6px; transition: all 0.14s; white-space: nowrap;
  display: flex; align-items: center; gap: 5px;
}
.hdr-btn:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.5); color: var(--white); }
.hdr-btn.active { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.5); color: var(--white); }
.hdr-btn.hdr-btn-stats {
  background: #2563eb; border-color: #3b82f6; color: white; font-weight: 700;
}
.hdr-btn.hdr-btn-stats:hover { background: #1d4ed8; border-color: #60a5fa; }
.hdr-btn.hdr-btn-timeline {
  background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.4); color: white; font-weight: 700;
}
.hdr-btn.hdr-btn-timeline:hover { background: rgba(255,255,255,0.22); }
.hdr-btn.hdr-btn-archive {
  background: #d97706; border-color: #f59e0b; color: white; font-weight: 700;
}
.hdr-btn.hdr-btn-archive:hover { background: #b45309; border-color: #d97706; }
.hdr-btn.hdr-btn-archive.active { background: #b45309; border-color: #f59e0b; }
.badge-cnt { background: rgba(255,255,255,0.25); color: white; border-radius: 9px; padding: 1px 6px; font-size: 0.6rem; font-weight: 700; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LAYOUT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.layout { display: grid; grid-template-columns: 278px 1fr; flex: 1; overflow: hidden; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.sidebar { background: var(--white); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }

.sidebar-search { padding: 10px 14px 8px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
.search-wrap { position: relative; display: flex; align-items: center; }
.search-icon { position: absolute; left: 9px; font-size: 1.1rem; color: var(--muted); pointer-events: none; line-height: 1; top: 50%; transform: translateY(-50%); }
#prop-search {
  width: 100%; padding: 7px 30px 7px 28px;
  border: 1px solid var(--border); background: var(--off-white);
  font-family: var(--font); font-size: 0.73rem; color: var(--navy);
  border-radius: 6px; outline: none; transition: border-color 0.12s, background 0.12s;
  box-sizing: border-box;
}
#prop-search:focus { border-color: var(--accent); background: var(--white); }
#prop-search::placeholder { color: var(--muted); }
.search-clear {
  position: absolute; right: 7px; background: none; border: none;
  color: var(--muted); font-size: 0.7rem; cursor: pointer; padding: 2px 4px;
  display: none; line-height: 1;
}
.search-clear.visible { display: block; }

.sidebar-filters { padding: 13px 14px 10px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
.sec-lbl { font-size: 0.58rem; font-weight: 700; letter-spacing: 0.13em; text-transform: uppercase; color: var(--muted); margin-bottom: 9px; }
.fg { margin-bottom: 7px; }
.fg label { font-size: 0.62rem; font-weight: 600; color: var(--muted); display: block; margin-bottom: 3px; }
.rr { display: flex; gap: 4px; align-items: center; }
.rr input { flex: 1; min-width: 0; padding: 5px 6px; border: 1px solid var(--border); background: var(--off-white); font-family: var(--font); font-size: 0.7rem; color: var(--navy); border-radius: 4px; outline: none; transition: border-color 0.12s; }
.rr input:focus { border-color: var(--accent); background: var(--white); }
.rr span { font-size: 0.65rem; color: var(--muted); flex-shrink: 0; }
select.full { width: 100%; padding: 5px 7px; border: 1px solid var(--border); background: var(--off-white); font-family: var(--font); font-size: 0.73rem; color: var(--navy); border-radius: 4px; outline: none; transition: border-color 0.12s; }
select.full:focus { border-color: var(--accent); background: var(--white); }
.chips { display: flex; gap: 4px; flex-wrap: wrap; }
.chip { padding: 3px 9px; border: 1px solid var(--border); border-radius: 20px; font-size: 0.63rem; font-weight: 600; cursor: pointer; background: var(--off-white); color: var(--muted); transition: all 0.12s; user-select: none; }
.chip.active { background: var(--navy); color: var(--white); border-color: var(--navy); }
.chip:hover:not(.active) { border-color: var(--navy); color: var(--navy); background: var(--white); }
.btn-reset { width: 100%; padding: 5px; background: transparent; border: 1px solid var(--border); color: var(--muted); font-family: var(--font); font-size: 0.63rem; font-weight: 600; cursor: pointer; border-radius: 4px; transition: all 0.12s; margin-top: 5px; }
.btn-reset:hover { background: var(--navy); color: var(--white); border-color: var(--navy); }

.res-count { padding: 6px 14px; font-size: 0.63rem; font-weight: 600; color: var(--muted); border-bottom: 1px solid var(--border); background: var(--off-white); flex-shrink: 0; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROPERTY LIST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.prop-list { flex: 1; overflow-y: auto; }
.prop-list::-webkit-scrollbar { width: 3px; }
.prop-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.pi { padding: 9px 14px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.1s; }
.pi:hover { background: var(--off-white); }
.pi.hl { background: #eff6ff; border-left: 3px solid var(--accent); padding-left: 11px; }
.pi.arc { opacity: 0.65; }
.pi-addr { font-size: 0.77rem; font-weight: 700; line-height: 1.3; color: var(--navy); }
.pi-name { font-size: 0.65rem; color: var(--muted); margin-bottom: 4px; }
.pi-meta { display: flex; gap: 4px; align-items: center; flex-wrap: wrap; }
.bdg { font-size: 0.58rem; font-weight: 700; padding: 2px 6px; border-radius: 3px; white-space: nowrap; }
.bdg-g { background: var(--green-bg); color: var(--green); }
.bdg-r { background: var(--red-bg); color: var(--red); }
.bdg-n { background: rgba(8,25,55,0.07); color: var(--navy); }
.pi-comp { opacity:0.9; }
.pi-comp:hover { opacity:1; background: rgba(124,58,237,0.06) !important; }
.bdg-gr { background: var(--gray-bg); color: var(--gray); border: 1px solid var(--border); }
.bdg-arc { background: #fef3c7; color: #92400e; }
.pi-price { font-size: 0.7rem; font-weight: 700; color: var(--navy); margin-left: auto; }
.pi-days { font-size: 0.6rem; color: var(--muted); margin-top: 3px; display: flex; align-items: center; gap: 5px; }
.pi-days strong { font-weight: 700; color: var(--navy); }
.days-bar { display: inline-flex; gap: 1px; width: 80px; height: 4px; vertical-align: middle; }
.days-seg { flex: 1; border-radius: 1px; background: var(--border); transition: background 0.2s; }
.days-seg.filled-1 { background: #16a34a; }
.days-seg.filled-2 { background: #22c55e; }
.days-seg.filled-3 { background: var(--gold); }
.days-seg.filled-4 { background: #ea580c; }
.days-seg.filled-5 { background: var(--red); }
.pi-phase { font-size: 0.6rem; font-weight: 600; color: var(--accent); margin-top: 2px; letter-spacing: 0.01em; }
.no-res { padding: 24px 14px; text-align: center; color: var(--muted); font-size: 0.75rem; line-height: 1.5; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ARCHIVE BANNER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.arc-banner { display: none; background: #fffbeb; border-bottom: 1px solid #fde68a; padding: 5px 14px; font-size: 0.67rem; color: #92400e; font-weight: 600; flex-shrink: 0; align-items: center; gap: 8px; }
.arc-banner.on { display: flex; }
.arc-close { margin-left: auto; cursor: pointer; font-weight: 700; background: none; border: none; color: #b45309; font-size: 0.75rem; padding: 0 2px; font-family: var(--font); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#map-container { position: relative; }
#map { width: 100%; height: 100%; }
.map-legend { position: absolute; bottom: 26px; left: 12px; z-index: 500; background: rgba(255,255,255,0.97); border: 1px solid var(--border); border-radius: 7px; padding: 10px 13px; font-size: 0.65rem; box-shadow: 0 2px 12px rgba(0,0,0,0.1); }
.leg-ttl { font-size: 0.56rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
.leg-row { display: flex; align-items: center; gap: 7px; margin-bottom: 4px; color: var(--navy); font-weight: 600; }
.leg-row:last-child { margin-bottom: 0; }
.leg-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; border: 2px solid white; box-shadow: 0 0 0 1px rgba(0,0,0,0.12); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TIMELINE MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(8,25,55,0.55); z-index: 2000;
  display: none; align-items: center; justify-content: center;
  backdrop-filter: blur(3px);
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--white); border-radius: 12px; width: 90vw; max-width: 960px;
  max-height: 88vh; overflow-y: auto; box-shadow: 0 24px 64px rgba(8,25,55,0.35);
  display: flex; flex-direction: column;
}
.modal::-webkit-scrollbar { width: 4px; }
.modal::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
.modal-hdr {
  background: var(--navy); color: var(--white); padding: 20px 28px 18px;
  border-radius: 12px 12px 0 0; flex-shrink: 0; display: flex; align-items: flex-start; justify-content: space-between;
}
.modal-hdr h2 { font-size: 1.4rem; font-weight: 800; letter-spacing: -0.3px; }
.modal-hdr p { font-size: 0.73rem; color: rgba(255,255,255,0.55); margin-top: 4px; max-width: 640px; line-height: 1.5; }
.modal-close { background: rgba(255,255,255,0.12); border: none; color: var(--white); width: 30px; height: 30px; border-radius: 50%; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-left: 16px; margin-top: 2px; transition: background 0.12s; font-family: var(--font); }
.modal-close:hover { background: rgba(255,255,255,0.25); }
.modal-body { padding: 28px; }

/* Stats Modal */
.stats-modal-inner { max-width: 1100px; }
.stats-modal-body { padding: 24px 28px; }

.stats-section-lbl {
  font-size: 0.58rem; font-weight: 800; letter-spacing: 0.14em; text-transform: uppercase;
  color: var(--muted); margin-bottom: 12px; margin-top: 24px; padding-bottom: 6px;
  border-bottom: 1px solid var(--border);
}
.stats-section-lbl:first-child { margin-top: 0; }

/* Big number cards */
.stats-kpi-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 4px; }
.stats-kpi {
  background: var(--off-white); border-radius: 9px; padding: 14px 16px;
  border: 1px solid var(--border);
}
.stats-kpi .kv { font-size: 1.6rem; font-weight: 800; color: var(--navy); line-height: 1; }
.stats-kpi .kl { font-size: 0.58rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-top: 5px; }
.stats-kpi.accent { background: var(--navy); border-color: var(--navy); }
.stats-kpi.accent .kv { color: white; }
.stats-kpi.accent .kl { color: rgba(255,255,255,0.45); }
.stats-kpi.gold { background: #fffbeb; border-color: #fde68a; }
.stats-kpi.gold .kv { color: #92400e; }
.stats-kpi.gold .kl { color: #b45309; }

/* Two-col layout */
.stats-two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.stats-three-col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }

/* Bar chart rows */
.stats-bar-group { background: var(--off-white); border: 1px solid var(--border); border-radius: 9px; padding: 14px 16px; }
.stats-bar-group-title { font-size: 0.65rem; font-weight: 700; color: var(--navy); margin-bottom: 10px; }
.stats-bar-row { display: flex; align-items: center; gap: 8px; margin-bottom: 7px; }
.stats-bar-row:last-child { margin-bottom: 0; }
.stats-bar-lbl { font-size: 0.62rem; color: var(--navy); font-weight: 600; width: 36px; flex-shrink: 0; }
.stats-bar-lbl.wide { width: 110px; }
.stats-bar-track { flex: 1; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
.stats-bar-fill { height: 100%; border-radius: 4px; transition: width 0.4s ease; }
.stats-bar-val { font-size: 0.62rem; font-weight: 700; color: var(--muted); width: 48px; text-align: right; flex-shrink: 0; }
.stats-bar-val.wide { width: 80px; }

/* Phase timeline strip */
.stats-phase-row { display: grid; grid-template-columns: repeat(5,1fr); gap: 8px; }
.stats-phase-card {
  background: var(--off-white); border: 1px solid var(--border); border-radius: 7px;
  padding: 12px 12px 10px; text-align: center;
}
.stats-phase-card .pv { font-size: 1.3rem; font-weight: 800; color: var(--navy); line-height: 1; }
.stats-phase-card .pl { font-size: 0.55rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); margin-top: 4px; line-height: 1.3; }
.stats-phase-card .pb { height: 3px; border-radius: 2px; margin-top: 8px; }

/* Timeline */
.tl-wrap { position: relative; }
.tl-track {
  display: flex; align-items: stretch;
  border-radius: 8px; overflow: hidden;
  box-shadow: 0 2px 8px rgba(8,25,55,0.1);
  margin-bottom: 24px;
}
.tl-seg {
  flex: 1; padding: 12px 10px 10px; background: var(--off-white);
  border-right: 2px solid var(--white); position: relative; min-width: 0;
  transition: background 0.15s;
}
.tl-seg:last-child { border-right: none; }
.tl-seg:hover { background: #e8edf5; }
.tl-seg.seg-start { flex: 0 0 72px; background: var(--navy); }
.tl-seg-days { font-size: 0.8rem; font-weight: 800; color: var(--navy); line-height: 1; }
.tl-seg.seg-start .tl-seg-days { color: var(--white); font-size: 0.72rem; }
.tl-seg-unit { font-size: 0.56rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; margin-top: 1px; }
.tl-seg.seg-start .tl-seg-unit { color: rgba(255,255,255,0.5); }
.tl-seg-lbl { font-size: 0.67rem; font-weight: 700; color: var(--navy); margin-top: 6px; line-height: 1.3; }
.tl-seg.seg-start .tl-seg-lbl { color: rgba(255,255,255,0.85); font-size: 0.62rem; }

.tl-events-row { display: flex; margin-bottom: 20px; }
.tl-event-spacer { flex: 0 0 72px; }
.tl-events { flex: 1; display: flex; gap: 0; }
.tl-event-col { flex: 1; padding: 0 6px; display: flex; flex-direction: column; gap: 6px; }

.tl-event {
  border-radius: 6px; padding: 8px 10px; font-size: 0.67rem; line-height: 1.4;
  border-left: 3px solid transparent; position: relative;
}
.tl-event-if { background: #e8f0fb; border-left-color: var(--accent); color: #1e3a6e; }
.tl-event-good { background: var(--green-bg); border-left-color: var(--green); color: #14532d; }
.tl-event-bad { background: var(--red-bg); border-left-color: var(--red); color: #7f1d1d; }
.tl-event-arrow { position: absolute; top: 50%; right: -14px; transform: translateY(-50%); font-size: 0.75rem; color: var(--muted); z-index: 1; }
.tl-event strong { font-weight: 700; display: block; margin-bottom: 2px; }
.tl-event .tag { display: inline-block; padding: 1px 5px; border-radius: 3px; font-size: 0.58rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 3px; }
.tag-if { background: var(--accent); color: white; }
.tag-then { background: var(--green); color: white; }
.tag-close { background: var(--red); color: white; }

.tl-total { text-align: center; padding: 10px 16px; background: var(--navy); border-radius: 7px; color: var(--white); font-size: 0.75rem; font-weight: 700; letter-spacing: 0.04em; }
.tl-total span { color: rgba(255,255,255,0.55); font-weight: 400; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê IMPORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.import-toggle { position: fixed; bottom: 18px; right: 18px; z-index: 1000; background: var(--navy); color: var(--white); border: none; padding: 9px 15px; font-family: var(--font); font-size: 0.67rem; font-weight: 700; cursor: pointer; border-radius: 7px; box-shadow: 0 4px 16px rgba(8,25,55,0.3); transition: all 0.14s; }
.import-toggle:hover { background: var(--navy-light); transform: translateY(-1px); }
.import-panel { position: fixed; bottom: 58px; right: 18px; z-index: 1000; background: var(--white); border: 1px solid var(--border); border-radius: 10px; padding: 17px; width: 385px; box-shadow: 0 8px 32px rgba(8,25,55,0.15); display: none; }
.import-panel.open { display: block; }
.import-panel h3 { font-size: 0.95rem; font-weight: 800; color: var(--navy); margin-bottom: 3px; }
.import-panel > p { font-size: 0.7rem; color: var(--muted); margin-bottom: 9px; line-height: 1.5; }
.col-hint { font-size: 0.6rem; color: var(--muted); margin-bottom: 11px; padding: 7px 9px; background: var(--off-white); border-radius: 4px; line-height: 1.8; border: 1px solid var(--border); }
.imp-tabs { display: flex; margin-bottom: 11px; background: var(--off-white); border-radius: 5px; padding: 3px; gap: 2px; }
.imp-tab { flex: 1; padding: 5px; text-align: center; font-family: var(--font); font-size: 0.63rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; border-radius: 3px; background: transparent; color: var(--muted); border: none; transition: all 0.12s; }
.imp-tab.active { background: var(--white); color: var(--navy); box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
.imp-content { display: none; }
.imp-content.active { display: block; }
textarea { width: 100%; height: 88px; padding: 8px; border: 1px solid var(--border); background: var(--off-white); font-family: monospace; font-size: 0.67rem; color: var(--navy); resize: vertical; border-radius: 4px; outline: none; margin-bottom: 7px; transition: border-color 0.12s; }
textarea:focus { border-color: var(--accent); background: var(--white); }
.btn-imp { width: 100%; padding: 7px; background: var(--navy); color: white; border: none; font-family: var(--font); font-size: 0.67rem; font-weight: 700; cursor: pointer; border-radius: 4px; transition: background 0.12s; margin-bottom: 5px; }
.btn-imp:hover { background: var(--navy-light); }
.btn-clr { width: 100%; padding: 5px; background: transparent; color: var(--red); border: 1px solid #fca5a5; font-family: var(--font); font-size: 0.63rem; font-weight: 600; cursor: pointer; border-radius: 4px; transition: all 0.12s; }
.btn-clr:hover { background: var(--red-bg); }
.file-drop { border: 2px dashed var(--border); border-radius: 5px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.12s; margin-bottom: 7px; }
.file-drop:hover, .file-drop.dov { border-color: var(--accent); background: #eff6ff; }
.file-drop p { font-size: 0.7rem; color: var(--muted); }
.file-drop input { display: none; }
.imp-msg { font-size: 0.65rem; font-weight: 600; padding: 6px 9px; border-radius: 4px; margin-top: 6px; display: none; }
.imp-msg.ok { background: var(--green-bg); color: var(--green); display: block; }
.imp-msg.err { background: var(--red-bg); color: var(--red); display: block; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GITHUB SYNC ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.gh-sync-btn { position: fixed; bottom: 18px; right: 420px; z-index: 1000; background: #24292f; color: var(--white); border: none; padding: 9px 13px; font-family: var(--font); font-size: 0.67rem; font-weight: 700; cursor: pointer; border-radius: 7px; box-shadow: 0 4px 16px rgba(0,0,0,0.25); transition: all 0.14s; white-space: nowrap; display: flex; align-items: center; gap: 6px; }
.gh-sync-btn:hover { background: #383f47; transform: translateY(-1px); }
.gh-sync-btn.syncing { opacity: 0.7; cursor: wait; }
.gh-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 2000; display: none; align-items: center; justify-content: center; }
.gh-modal-overlay.open { display: flex; }
.gh-modal { background: var(--white); border-radius: 12px; padding: 24px; width: 420px; box-shadow: 0 16px 48px rgba(0,0,0,0.25); }
.gh-modal h3 { font-size: 1rem; font-weight: 800; color: var(--navy); margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
.gh-modal p { font-size: 0.7rem; color: var(--muted); margin-bottom: 16px; line-height: 1.6; }
.gh-field { margin-bottom: 12px; }
.gh-field label { display: block; font-size: 0.65rem; font-weight: 700; color: var(--navy); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 4px; }
.gh-field input { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 5px; font-family: var(--font); font-size: 0.75rem; color: var(--navy); outline: none; transition: border-color 0.12s; box-sizing: border-box; }
.gh-field input:focus { border-color: #24292f; }
.gh-field input[type=password] { font-family: monospace; letter-spacing: 0.05em; }
.gh-modal-btns { display: flex; gap: 8px; margin-top: 16px; }
.gh-btn-save { flex: 1; padding: 9px; background: #24292f; color: white; border: none; font-family: var(--font); font-size: 0.72rem; font-weight: 700; cursor: pointer; border-radius: 5px; transition: background 0.12s; }
.gh-btn-save:hover { background: #383f47; }
.gh-btn-cancel { padding: 9px 14px; background: transparent; color: var(--muted); border: 1px solid var(--border); font-family: var(--font); font-size: 0.72rem; font-weight: 600; cursor: pointer; border-radius: 5px; }
.gh-status { font-size: 0.65rem; font-weight: 600; padding: 7px 10px; border-radius: 5px; margin-top: 10px; display: none; }
.gh-status.ok { background: var(--green-bg); color: var(--green); display: block; }
.gh-status.err { background: var(--red-bg); color: var(--red); display: block; }
.gh-sync-dot { width: 7px; height: 7px; border-radius: 50%; background: #6b7280; display: inline-block; flex-shrink: 0; }
.gh-sync-dot.configured { background: #22c55e; }
.gh-sync-dot.error { background: #ef4444; }
:root { --comp: #7c3aed; --comp-bg: #ede9fe; --comp-light: #a78bfa; }
.comp-toggle { position: fixed; bottom: 18px; right: 215px; z-index: 1000; background: var(--comp); color: var(--white); border: none; padding: 9px 13px; font-family: var(--font); font-size: 0.67rem; font-weight: 700; cursor: pointer; border-radius: 7px; box-shadow: 0 4px 16px rgba(124,58,237,0.35); transition: all 0.14s; white-space: nowrap; }
.comp-toggle:hover { background: #6d28d9; transform: translateY(-1px); }
.comp-panel { position: fixed; bottom: 58px; right: 215px; z-index: 1000; background: var(--white); border: 1px solid var(--border); border-radius: 10px; padding: 17px; width: 420px; box-shadow: 0 8px 32px rgba(8,25,55,0.15); display: none; max-height: 80vh; overflow-y: auto; }
.comp-panel.open { display: block; }
.comp-panel::-webkit-scrollbar { width: 3px; }
.comp-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
.comp-panel h3 { font-size: 0.95rem; font-weight: 800; color: var(--navy); margin-bottom: 3px; display: flex; align-items: center; gap: 7px; }
.comp-panel > p { font-size: 0.7rem; color: var(--muted); margin-bottom: 11px; line-height: 1.5; }
.comp-section-hdr { font-size: 0.58rem; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--comp); margin: 12px 0 7px; border-top: 1px solid var(--border); padding-top: 10px; }
.comp-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px 8px; margin-bottom: 8px; }
.comp-form-grid .fg { margin-bottom: 0; }
.comp-form-grid .fg.wide { grid-column: 1/-1; }
.comp-form-grid label { font-size: 0.6rem; font-weight: 600; color: var(--muted); display: block; margin-bottom: 2px; }
.comp-form-grid input, .comp-form-grid textarea { width: 100%; padding: 5px 6px; border: 1px solid var(--border); background: var(--off-white); font-family: var(--font); font-size: 0.7rem; color: var(--navy); border-radius: 4px; outline: none; transition: border-color 0.12s; }
.comp-form-grid input:focus, .comp-form-grid textarea:focus { border-color: var(--comp); background: white; }
.comp-form-grid textarea { height: 48px; resize: vertical; }
.comp-col-hint { font-size: 0.58rem; color: var(--muted); padding: 6px 8px; background: var(--off-white); border-radius: 4px; border: 1px solid var(--border); line-height: 1.8; margin-bottom: 9px; }
.btn-comp { width: 100%; padding: 7px; background: var(--comp); color: white; border: none; font-family: var(--font); font-size: 0.67rem; font-weight: 700; cursor: pointer; border-radius: 4px; transition: background 0.12s; margin-bottom: 5px; }
.btn-comp:hover { background: #6d28d9; }
.btn-comp-outline { width: 100%; padding: 6px; background: transparent; color: var(--comp); border: 1px solid var(--comp-light); font-family: var(--font); font-size: 0.63rem; font-weight: 600; cursor: pointer; border-radius: 4px; transition: all 0.12s; margin-bottom: 5px; }
.btn-comp-outline:hover { background: var(--comp-bg); }
.comp-imp-msg { font-size: 0.65rem; font-weight: 600; padding: 6px 9px; border-radius: 4px; margin-top: 5px; display: none; }
.comp-imp-msg.ok { background: var(--green-bg); color: var(--green); display: block; }
.comp-imp-msg.err { background: var(--red-bg); color: var(--red); display: block; }

/* Comps sidebar section */
.comps-sidebar { padding: 10px 14px; border-top: 2px solid var(--comp-bg); flex-shrink: 0; max-height: 220px; overflow-y: auto; }
.comps-sidebar::-webkit-scrollbar { width: 3px; }
.comps-sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
.comp-list-item { padding: 7px 0; border-bottom: 1px solid var(--border); cursor: pointer; transition: opacity 0.1s; }
.comp-list-item:last-child { border-bottom: none; }
.comp-list-item:hover { opacity: 0.75; }
.cli-addr { font-size: 0.7rem; font-weight: 700; color: var(--comp); line-height: 1.3; }
.cli-meta { font-size: 0.62rem; color: var(--muted); margin-top: 2px; display: flex; gap: 6px; }
.cli-meta strong { color: var(--navy); }
.cli-match { font-size: 0.58rem; color: var(--green); font-weight: 600; margin-top: 1px; }
.cli-unmatched { font-size: 0.58rem; color: var(--comp); font-weight: 600; margin-top: 1px; }

/* Match modal */
.match-modal { position: fixed; inset: 0; background: rgba(8,25,55,0.6); z-index: 3000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
.match-modal.open { display: flex; }
.match-box { background: var(--white); border-radius: 12px; width: 90vw; max-width: 780px; max-height: 88vh; overflow-y: auto; box-shadow: 0 24px 64px rgba(8,25,55,0.3); }
.match-box::-webkit-scrollbar { width: 4px; }
.match-box::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
.match-hdr { background: var(--comp); color: white; padding: 18px 24px 16px; border-radius: 12px 12px 0 0; display: flex; align-items: flex-start; justify-content: space-between; flex-shrink: 0; }
.match-hdr h2 { font-size: 1.1rem; font-weight: 800; }
.match-hdr p { font-size: 0.7rem; color: rgba(255,255,255,0.7); margin-top: 3px; }
.match-body { padding: 20px 24px; }
.match-comp-card { background: var(--comp-bg); border: 1px solid var(--comp-light); border-radius: 8px; padding: 12px 14px; margin-bottom: 14px; }
.match-comp-card h4 { font-size: 0.78rem; font-weight: 800; color: var(--comp); margin-bottom: 3px; }
.match-comp-card .mc-meta { display: flex; gap: 10px; flex-wrap: wrap; font-size: 0.68rem; color: var(--navy); }
.match-comp-card .mc-meta span { font-weight: 600; }
.match-section-lbl { font-size: 0.58rem; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); margin: 12px 0 7px; }
.match-candidate { display: flex; align-items: flex-start; gap: 10px; padding: 10px 12px; border: 2px solid var(--border); border-radius: 7px; margin-bottom: 7px; cursor: pointer; transition: all 0.12s; }
.match-candidate:hover { border-color: var(--comp-light); background: var(--comp-bg); }
.match-candidate.selected { border-color: var(--comp); background: var(--comp-bg); }
.mc-radio { width: 16px; height: 16px; border-radius: 50%; border: 2px solid var(--border); flex-shrink: 0; margin-top: 2px; transition: all 0.12s; }
.match-candidate.selected .mc-radio { border-color: var(--comp); background: var(--comp); }
.mc-info h5 { font-size: 0.73rem; font-weight: 700; color: var(--navy); }
.mc-info p { font-size: 0.63rem; color: var(--muted); margin-top: 1px; }
.mc-score { font-size: 0.58rem; font-weight: 700; padding: 2px 6px; border-radius: 3px; white-space: nowrap; }
.mc-score-hi { background: var(--green-bg); color: var(--green); }
.mc-score-med { background: #fef3c7; color: #92400e; }
.match-btn-row { display: flex; gap: 7px; margin-top: 12px; }
.match-btn-accept { flex: 1; padding: 8px; background: var(--comp); color: white; border: none; font-family: var(--font); font-size: 0.7rem; font-weight: 700; cursor: pointer; border-radius: 5px; transition: background 0.12s; }
.match-btn-accept:hover { background: #6d28d9; }
.match-btn-skip { flex: 1; padding: 8px; background: transparent; color: var(--muted); border: 1px solid var(--border); font-family: var(--font); font-size: 0.7rem; font-weight: 600; cursor: pointer; border-radius: 5px; transition: all 0.12s; }
.match-btn-skip:hover { background: var(--off-white); }
.match-no-candidates { padding: 14px; background: var(--off-white); border-radius: 7px; text-align: center; font-size: 0.7rem; color: var(--muted); }
.match-progress { font-size: 0.7rem; color: rgba(255,255,255,0.7); margin-top: 4px; }

/* Comp accordion in popup ‚Äî replaced by gold sidebar panel */
.pu-comp-card { background: rgba(124,58,237,0.18); border: 1px solid rgba(167,139,250,0.3); border-radius: 6px; padding: 9px 11px; margin-bottom: 7px; }
.pu-comp-card:last-child { margin-bottom: 0; }
.pu-comp-addr { font-size: 0.68rem; font-weight: 700; color: #c4b5fd; line-height: 1.3; margin-bottom: 5px; }
.pu-comp-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 10px; }
.pu-comp-f label { font-size: 0.52rem; font-weight: 700; letter-spacing: 0.09em; text-transform: uppercase; color: rgba(255,255,255,0.35); display: block; margin-bottom: 1px; }
.pu-comp-f span { font-size: 0.7rem; font-weight: 500; color: rgba(255,255,255,0.9); }
.pu-comp-f.wide { grid-column: 1/-1; }
.pu-comp-notes { font-size: 0.62rem; color: rgba(255,255,255,0.55); margin-top: 5px; font-style: italic; line-height: 1.4; }

/* Two-column popup: TOPA info left, comps right */
.pop-outer { display: flex; gap: 0; align-items: stretch; }
.pop-topa-col { flex: 0 0 300px; min-width: 0; }
.pop-comp-col {
  flex: 0 0 280px; min-width: 0;
  border-left: 3px solid #d97706;
  margin-left: 12px; padding-left: 14px;
  display: flex; flex-direction: column;
}
.pop-comp-col-hdr {
  font-size: 0.58rem; font-weight: 800; letter-spacing: 0.1em;
  text-transform: uppercase; color: #d97706;
  margin-bottom: 8px; display: flex; align-items: center; gap: 6px;
}
.pop-comp-count {
  background: #d97706; color: white; border-radius: 8px;
  padding: 1px 6px; font-size: 0.55rem; font-weight: 700;
}
.pop-comp-col-body { overflow-y: auto; flex: 1; max-height: 320px; }
.pop-comp-col-body::-webkit-scrollbar { width: 3px; }
.pop-comp-col-body::-webkit-scrollbar-thumb { background: rgba(217,119,6,0.3); border-radius: 2px; }
.pop-comp-card {
  background: rgba(217,119,6,0.12); border: 1px solid rgba(217,119,6,0.25);
  border-radius: 5px; padding: 8px 10px; margin-bottom: 7px;
}
.pop-comp-card:last-child { margin-bottom: 0; }
.pop-comp-name { font-size: 0.67rem; font-weight: 700; color: #fbbf24; line-height: 1.3; margin-bottom: 2px; }
.pop-comp-sub { font-size: 0.58rem; color: rgba(255,255,255,0.45); margin-bottom: 5px; }
.pop-comp-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 3px 8px; }
.pop-comp-f label { font-size: 0.5rem; font-weight: 700; letter-spacing: 0.09em; text-transform: uppercase; color: rgba(255,255,255,0.3); display: block; margin-bottom: 1px; }
.pop-comp-f span { font-size: 0.67rem; font-weight: 500; color: rgba(255,255,255,0.88); }
.pop-comp-wide { grid-column: 1/-1; }
.pop-comp-notes { font-size: 0.58rem; color: rgba(255,255,255,0.4); margin-top: 5px; font-style: italic; line-height: 1.4; }

/* View comps button inside popup */
.pu-comp-sidebar-btn {
  margin-top: 10px; padding: 8px 12px;
  background: #d97706; color: white; border-radius: 5px;
  font-size: 0.65rem; font-weight: 700; cursor: pointer;
  text-align: center; letter-spacing: 0.03em;
  transition: background 0.12s;
}
.pu-comp-sidebar-btn:hover { background: #b45309; }

/* Gold comp sidebar panel */
.comp-sidebar-panel {
  position: fixed; top: 70px; right: 0; z-index: 1100;
  width: 320px; max-height: calc(100vh - 88px);
  background: var(--white); border-left: 4px solid #d97706;
  box-shadow: -4px 0 24px rgba(0,0,0,0.13);
  display: flex; flex-direction: column; overflow: hidden;
  transform: translateX(100%); transition: transform 0.22s ease;
  border-radius: 0;
}
.comp-sidebar-panel.open { transform: translateX(0); }
.comp-sidebar-hdr {
  background: #d97706; color: white; padding: 14px 16px 12px;
  display: flex; align-items: flex-start; justify-content: space-between;
  flex-shrink: 0;
}
.comp-sidebar-hdr-inner { flex: 1; min-width: 0; }
.comp-sidebar-title { font-size: 0.62rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: rgba(255,255,255,0.7); margin-bottom: 3px; }
.comp-sidebar-addr { font-size: 0.88rem; font-weight: 800; line-height: 1.3; color: white; }
.comp-sidebar-close {
  background: rgba(255,255,255,0.2); border: none; color: white;
  width: 26px; height: 26px; border-radius: 50%; font-size: 0.85rem;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; margin-left: 10px; font-family: var(--font);
  transition: background 0.12s;
}
.comp-sidebar-close:hover { background: rgba(255,255,255,0.35); }
.comp-sidebar-body { overflow-y: auto; padding: 14px 16px; flex: 1; }
.comp-sidebar-body::-webkit-scrollbar { width: 3px; }
.comp-sidebar-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
.comp-sidebar-card {
  background: #fffbeb; border: 1px solid #fde68a;
  border-radius: 7px; padding: 11px 13px; margin-bottom: 10px;
}
.comp-sidebar-card:last-child { margin-bottom: 0; }
.comp-sidebar-card-name { font-size: 0.7rem; font-weight: 800; color: #92400e; margin-bottom: 6px; line-height: 1.3; }
.comp-sidebar-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px 12px; }
.comp-sidebar-f label { font-size: 0.52rem; font-weight: 700; letter-spacing: 0.09em; text-transform: uppercase; color: #b45309; display: block; margin-bottom: 1px; }
.comp-sidebar-f span { font-size: 0.72rem; font-weight: 600; color: #1c1917; }
.comp-sidebar-f.wide { grid-column: 1/-1; }
.comp-sidebar-notes { font-size: 0.63rem; color: #78716c; margin-top: 7px; font-style: italic; line-height: 1.4; padding-top: 7px; border-top: 1px solid #fde68a; }

/* Floating comps detail panel (opens when clicking a comp in sidebar) */
.comp-detail-panel {
  position: fixed; top: 70px; right: 18px; z-index: 1200;
  width: 340px; max-height: calc(100vh - 88px);
  background: var(--white); border: 1px solid var(--border);
  border-radius: 11px; box-shadow: 0 8px 36px rgba(8,25,55,0.18);
  display: none; flex-direction: column; overflow: hidden;
}
.comp-detail-panel.open { display: flex; }
.comp-detail-hdr {
  background: #7c3aed; color: white; padding: 14px 16px 12px;
  display: flex; align-items: flex-start; justify-content: space-between;
  flex-shrink: 0; border-radius: 10px 10px 0 0;
}
.comp-detail-hdr h4 { font-size: 0.88rem; font-weight: 800; line-height: 1.3; }
.comp-detail-hdr .cdh-sub { font-size: 0.63rem; color: rgba(255,255,255,0.65); margin-top: 2px; }
.comp-detail-close {
  background: rgba(255,255,255,0.15); border: none; color: white;
  width: 24px; height: 24px; border-radius: 50%; font-size: 0.8rem;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; margin-left: 10px; margin-top: 1px; font-family: var(--font);
  transition: background 0.12s;
}
.comp-detail-close:hover { background: rgba(255,255,255,0.28); }
.comp-detail-body { overflow-y: auto; padding: 14px 16px; flex: 1; }
.comp-detail-body::-webkit-scrollbar { width: 3px; }
.comp-detail-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
.cdg { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 14px; margin-bottom: 12px; }
.cdg-f label { font-size: 0.55rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); display: block; margin-bottom: 2px; }
.cdg-f span { font-size: 0.8rem; font-weight: 600; color: var(--navy); }
.cdg-f.wide { grid-column: 1/-1; }
.cd-section-lbl { font-size: 0.55rem; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--comp); margin: 10px 0 6px; padding-top: 10px; border-top: 1px solid var(--border); }
.cd-notes { font-size: 0.68rem; color: var(--muted); line-height: 1.5; font-style: italic; padding: 8px 10px; background: var(--off-white); border-radius: 5px; }
.cd-topa-link { margin-top: 10px; padding: 8px 10px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px; font-size: 0.67rem; color: var(--accent); font-weight: 600; }

/* Comps sidebar header */
.comp-cnt-badge { font-size: 0.6rem; font-weight: 700; background: var(--comp-bg); color: var(--comp); padding: 1px 6px; border-radius: 9px; }
.btn-comp-export { font-size: 0.58rem; font-weight: 700; padding: 2px 7px; background: transparent; border: 1px solid var(--comp-light); color: var(--comp); border-radius: 3px; cursor: pointer; font-family: var(--font); transition: all 0.12s; }
.btn-comp-export:hover { background: var(--comp-bg); }

/* JSON export panel */
.comp-export-section { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }



/* Match modal */
.match-modal { position: fixed; inset: 0; background: rgba(8,25,55,0.6); z-index: 3000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
.match-modal.open { display: flex; }
.match-box { background: var(--white); border-radius: 12px; width: 90vw; max-width: 780px; max-height: 88vh; overflow-y: auto; box-shadow: 0 24px 64px rgba(8,25,55,0.3); }
.match-box::-webkit-scrollbar { width: 4px; }
.match-box::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
.match-hdr { background: var(--comp); color: white; padding: 18px 24px 16px; border-radius: 12px 12px 0 0; display: flex; align-items: flex-start; justify-content: space-between; flex-shrink: 0; }
.match-hdr h2 { font-size: 1.1rem; font-weight: 800; }
.match-hdr p { font-size: 0.7rem; color: rgba(255,255,255,0.7); margin-top: 3px; }
.match-body { padding: 20px 24px; }
.match-comp-card { background: var(--comp-bg); border: 1px solid var(--comp-light); border-radius: 8px; padding: 12px 14px; margin-bottom: 14px; }
.match-comp-card h4 { font-size: 0.78rem; font-weight: 800; color: var(--comp); margin-bottom: 3px; }
.match-comp-card .mc-meta { display: flex; gap: 10px; flex-wrap: wrap; font-size: 0.68rem; color: var(--navy); }
.match-comp-card .mc-meta span { font-weight: 600; }
.match-section-lbl { font-size: 0.58rem; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); margin: 12px 0 7px; }
.match-candidate { display: flex; align-items: flex-start; gap: 10px; padding: 10px 12px; border: 2px solid var(--border); border-radius: 7px; margin-bottom: 7px; cursor: pointer; transition: all 0.12s; }
.match-candidate:hover { border-color: var(--comp-light); background: var(--comp-bg); }
.match-candidate.selected { border-color: var(--comp); background: var(--comp-bg); }
.mc-radio { width: 16px; height: 16px; border-radius: 50%; border: 2px solid var(--border); flex-shrink: 0; margin-top: 2px; transition: all 0.12s; }
.match-candidate.selected .mc-radio { border-color: var(--comp); background: var(--comp); }
.mc-info h5 { font-size: 0.73rem; font-weight: 700; color: var(--navy); }
.mc-info p { font-size: 0.63rem; color: var(--muted); margin-top: 1px; }
.mc-score { font-size: 0.58rem; font-weight: 700; padding: 2px 6px; border-radius: 3px; white-space: nowrap; }
.mc-score-hi { background: var(--green-bg); color: var(--green); }
.mc-score-med { background: #fef3c7; color: #92400e; }
.match-btn-row { display: flex; gap: 7px; margin-top: 12px; }
.match-btn-accept { flex: 1; padding: 8px; background: var(--comp); color: white; border: none; font-family: var(--font); font-size: 0.7rem; font-weight: 700; cursor: pointer; border-radius: 5px; transition: background 0.12s; }
.match-btn-accept:hover { background: #6d28d9; }
.match-btn-skip { flex: 1; padding: 8px; background: transparent; color: var(--muted); border: 1px solid var(--border); font-family: var(--font); font-size: 0.7rem; font-weight: 600; cursor: pointer; border-radius: 5px; transition: all 0.12s; }
.match-btn-skip:hover { background: var(--off-white); }
.match-no-candidates { padding: 14px; background: var(--off-white); border-radius: 7px; text-align: center; font-size: 0.7rem; color: var(--muted); }
.match-progress { font-size: 0.7rem; color: rgba(255,255,255,0.7); margin-top: 4px; }

/* Unmatched comp marker color in legend */
.leg-dot-comp { background: #7c3aed; }
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LEAFLET POPUP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.leaflet-popup-content-wrapper { background: var(--navy); color: var(--white); border-radius: 8px; border: none; box-shadow: 0 8px 24px rgba(8,25,55,0.4); }
.leaflet-popup-tip { background: var(--navy); }
.leaflet-popup-content { margin: 13px 15px; font-family: var(--font); min-width: 215px; }
.leaflet-popup-close-button { color: rgba(255,255,255,0.35) !important; font-size: 17px !important; }
.pu-addr { font-size: 0.83rem; font-weight: 700; margin-bottom: 1px; line-height: 1.3; }
.pu-name { font-size: 0.67rem; color: rgba(255,255,255,0.45); margin-bottom: 9px; }
.pu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 7px 14px; margin-bottom: 9px; }
.pu-f label { font-size: 0.54rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: rgba(255,255,255,0.38); display: block; margin-bottom: 1px; }
.pu-f span { font-size: 0.77rem; font-weight: 500; }
.pu-f.wide { grid-column: 1 / -1; }
.pu-tags { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 8px; }
.pu-tag { padding: 2px 7px; border-radius: 3px; font-size: 0.6rem; font-weight: 700; }
.pu-tag.c { background: var(--green); color: white; }
.pu-tag.nc { background: var(--red); color: white; }
.pu-tag.arc { background: var(--gray); color: white; }
.pu-topa-bar { margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); }
.pu-topa-lbl { font-size: 0.58rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: rgba(255,255,255,0.38); margin-bottom: 4px; }
.pu-topa-track { width: 100%; height: 4px; background: rgba(255,255,255,0.15); border-radius: 2px; overflow: hidden; margin-bottom: 4px; }
.pu-topa-fill { height: 100%; border-radius: 2px; }
.pu-topa-info { display: flex; justify-content: space-between; font-size: 0.67rem; }
.pu-topa-info strong { color: var(--white); font-weight: 700; }
.pu-topa-info span { color: rgba(255,255,255,0.45); }

/* TOPA Milestone progress bar in popup */
.pu-milestones { margin-top: 6px; }
.pu-ms-row { display: flex; align-items: center; gap: 5px; margin-bottom: 3px; }
.pu-ms-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.pu-ms-dot.past { background: var(--green); }
.pu-ms-dot.current { background: var(--gold); border: 2px solid white; }
.pu-ms-dot.future { background: rgba(255,255,255,0.2); }
.pu-ms-lbl { font-size: 0.62rem; color: rgba(255,255,255,0.6); }
.pu-ms-lbl.current { color: var(--white); font-weight: 600; }
.pu-ms-days { font-size: 0.58rem; color: rgba(255,255,255,0.38); margin-left: auto; }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê -->
<header>
  <div class="hdr-brand">
    <h1>TOPA Pipeline</h1>
    <div class="sub">DC Multifamily ¬∑ Offer of Sale Tracker</div>
  </div>
  <div class="hdr-asof">
    <div class="asof-lbl">As of</div>
    <div class="asof-val" id="asof-date">‚Äî</div>
  </div>
  <div class="hdr-stats">
    <div class="stat-blk"><span class="v" id="stat-props">‚Äî</span><span class="l">Active</span></div>
    <div class="stat-blk"><span class="v" id="stat-units">‚Äî</span><span class="l">Units</span></div>
    <div class="stat-blk"><span class="v" id="stat-vol">‚Äî</span><span class="l">Volume</span></div>
    <div class="stat-blk"><span class="v" id="stat-ppu">‚Äî</span><span class="l">Avg $/Unit</span></div>
  </div>
  <div class="hdr-btns">
    <button class="hdr-btn hdr-btn-stats" id="btn-stats">üìä Market Stats</button>
    <button class="hdr-btn hdr-btn-timeline" id="btn-timeline">üìã TOPA Timeline</button>
    <button class="hdr-btn hdr-btn-archive" id="btn-archive">üóÇ Archived <span class="badge-cnt" id="arc-cnt">0</span></button>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê‚ïê ARCHIVE BANNER ‚ïê‚ïê‚ïê‚ïê -->
<div class="arc-banner" id="arc-banner">
  Showing archived properties ‚Äî TOPA date is more than 420 days ago. These have likely completed or expired the process.
  <button class="arc-close" id="arc-close">‚úï Back to Active</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê MAIN LAYOUT ‚ïê‚ïê‚ïê‚ïê -->
<div class="layout">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-search">
      <div class="search-wrap">
        <span class="search-icon">‚åï</span>
        <input type="text" id="prop-search" placeholder="Search address or name‚Ä¶" autocomplete="off">
        <button class="search-clear" id="search-clear" title="Clear">‚úï</button>
      </div>
    </div>
    <div class="sidebar-filters">
      <div class="sec-lbl">Filters</div>
      <div class="fg">
        <label>Type of Offering</label>
        <div class="chips" id="chips-type">
          <div class="chip active" data-val="all">All</div>
          <div class="chip" data-val="w/ Contract">w/ Contract</div>
          <div class="chip" data-val="w/o Contract">w/o Contract</div>
        </div>
      </div>
      <div class="fg">
        <label>FOIA Source</label>
        <select class="full" id="filter-foia">
          <option value="">All Sources</option>
          <option value="FOIA">FOIA</option>
          <option value="Greysteel">Greysteel</option>
          <option value="Requested">Requested</option>
          <option value="Submitted">Submitted</option>
          <option value="-">None / Unknown</option>
        </select>
      </div>
      <div class="fg">
        <label>Units</label>
        <div class="rr"><input type="number" id="u-min" placeholder="Min" min="0"><span>‚Äì</span><input type="number" id="u-max" placeholder="Max" min="0"></div>
      </div>
      <div class="fg">
        <label>Price ($)</label>
        <div class="rr"><input type="number" id="p-min" placeholder="Min" min="0" step="100000"><span>‚Äì</span><input type="number" id="p-max" placeholder="Max" min="0" step="100000"></div>
      </div>
      <div class="fg">
        <label>Price / Unit ($)</label>
        <div class="rr"><input type="number" id="ppu-min" placeholder="Min" min="0" step="5000"><span>‚Äì</span><input type="number" id="ppu-max" placeholder="Max" min="0" step="5000"></div>
      </div>
      <div class="fg">
        <label>TOPA Date Range</label>
        <div class="rr"><input type="date" id="d-min"><span>‚Äì</span><input type="date" id="d-max"></div>
      </div>
      <div class="fg">
        <label>Days in TOPA</label>
        <div class="rr"><input type="number" id="days-min" placeholder="Min" min="0" max="420"><span>‚Äì</span><input type="number" id="days-max" placeholder="Max" min="0" max="420"></div>
      </div>
      <div class="fg">
        <label>Sort By</label>
        <select class="full" id="sort-by">
          <option value="date-desc">TOPA Date (Newest)</option>
          <option value="date-asc">TOPA Date (Oldest)</option>
          <option value="days-asc">Days in TOPA (Fewest)</option>
          <option value="days-desc">Days in TOPA (Most)</option>
          <option value="price-desc">Price (High ‚Üí Low)</option>
          <option value="price-asc">Price (Low ‚Üí High)</option>
          <option value="units-desc">Units (High ‚Üí Low)</option>
          <option value="units-asc">Units (Low ‚Üí High)</option>
          <option value="ppu-desc">Price/Unit (High ‚Üí Low)</option>
          <option value="ppu-asc">Price/Unit (Low ‚Üí High)</option>
        </select>
      </div>
      <button class="btn-reset" id="btn-reset">‚Ü∫  Reset All Filters</button>
    </div>
    <div class="res-count" id="res-count">‚Äî properties</div>
    <div class="prop-list" id="prop-list"></div>
  </div>

  <!-- MAP -->
  <div id="map-container">
    <div id="map"></div>
    <div class="map-legend">
      <div class="leg-ttl">Legend</div>
      <div class="leg-row"><div class="leg-dot" style="background:#059669"></div>TOPA (active)</div>
      <div class="leg-row"><div class="leg-dot" style="background:#d97706"></div>TOPA + Sale Comp</div>
      <div class="leg-row"><div class="leg-dot" style="background:#94a3b8"></div>Archived (420+ days)</div>
      <div class="leg-row"><div class="leg-dot" style="background:#7c3aed"></div>Sale Comp only</div>
    </div>

<!-- Floating Comp Detail Panel -->
<div class="comp-detail-panel" id="comp-detail-panel">
  <div class="comp-detail-hdr">
    <div>
      <h4 id="cdp-title">Sale Comp</h4>
      <div class="cdh-sub" id="cdp-sub"></div>
    </div>
    <button class="comp-detail-close" id="comp-detail-close">‚úï</button>
  </div>
  <div class="comp-detail-body" id="cdp-body"></div>
</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê TOPA TIMELINE MODAL ‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="tl-modal">
  <div class="modal">
    <div class="modal-hdr">
      <div>
        <h2>TOPA Timeline</h2>
        <p>The Tenant Opportunity to Purchase Act (TOPA) offers residents renting in the District of Columbia the opportunity to purchase their housing accommodation when an owner plans to sell. Below is a detailed flow-chart of TOPA timelines and requirements after contract execution.</p>
      </div>
      <button class="modal-close" id="tl-close">‚úï</button>
    </div>
    <div class="modal-body">

      <!-- PHASE TRACK -->
      <div class="tl-track">
        <div class="tl-seg seg-start">
          <div class="tl-seg-days">Day 0</div>
          <div class="tl-seg-unit">Start</div>
          <div class="tl-seg-lbl">Tenants Notified</div>
        </div>
        <div class="tl-seg">
          <div class="tl-seg-days">5</div>
          <div class="tl-seg-unit">days</div>
          <div class="tl-seg-lbl" style="color:var(--muted);font-size:0.6rem">Offer posted</div>
        </div>
        <div class="tl-seg" style="background:#dbeafe">
          <div class="tl-seg-days" style="color:var(--accent)">45</div>
          <div class="tl-seg-unit">days</div>
          <div class="tl-seg-lbl">TA Formation Window</div>
        </div>
        <div class="tl-seg" style="background:#dbeafe">
          <div class="tl-seg-days" style="color:var(--accent)">135</div>
          <div class="tl-seg-unit">days</div>
          <div class="tl-seg-lbl">TA Contract &amp; Deposit</div>
        </div>
        <div class="tl-seg" style="background:#dbeafe">
          <div class="tl-seg-days" style="color:var(--accent)">120</div>
          <div class="tl-seg-unit">days</div>
          <div class="tl-seg-lbl">TA Secure Financing</div>
        </div>
        <div class="tl-seg" style="background:#dbeafe">
          <div class="tl-seg-days" style="color:var(--accent)">120</div>
          <div class="tl-seg-unit">days</div>
          <div class="tl-seg-lbl">TA Financing Extension</div>
        </div>
        <div class="tl-seg" style="background:#dcfce7">
          <div class="tl-seg-days" style="color:var(--green)">Closing</div>
          <div class="tl-seg-unit">period</div>
          <div class="tl-seg-lbl">Tenants Go to Closing</div>
        </div>
      </div>

      <!-- EVENTS ROW -->
      <div class="tl-events-row">
        <div class="tl-event-spacer"></div>
        <div class="tl-events">
          <!-- Col 1: 5 days -->
          <div class="tl-event-col">
            <div class="tl-event tl-event-if">
              <span class="tag tag-if">IF</span>
              <strong>TA Exists</strong>
              Tenants have 30 days to respond &amp; form association. Clock begins.
            </div>
          </div>
          <!-- Col 2: 45 days -->
          <div class="tl-event-col">
            <div class="tl-event tl-event-good">
              <span class="tag tag-then">‚úì</span>
              <strong>TA Forms &amp; Responds</strong>
              Association established within 45 days.
            </div>
            <div class="tl-event tl-event-bad">
              <span class="tag tag-close">‚Üí CLOSE</span>
              <strong>No Formation / Response</strong>
              Move directly to Closing Period.
            </div>
          </div>
          <!-- Col 3: 135 days -->
          <div class="tl-event-col">
            <div class="tl-event tl-event-if">
              <span class="tag tag-if">REQ</span>
              <strong>TA Max Deposit</strong>
              TA must match contract &amp; post 5% of purchase price as deposit.
            </div>
            <div class="tl-event tl-event-bad">
              <span class="tag tag-close">‚Üí CLOSE</span>
              <strong>TA Does Not Match</strong>
              Fails to post deposit ‚Üí Closing Period.
            </div>
          </div>
          <!-- Col 4: 120 days financing -->
          <div class="tl-event-col">
            <div class="tl-event tl-event-if">
              <span class="tag tag-if">REQ</span>
              <strong>TA Must Secure Financing</strong>
              TA must demonstrate financing ability within 240 days total.
            </div>
            <div class="tl-event tl-event-bad">
              <span class="tag tag-close">‚Üí CLOSE</span>
              <strong>Cannot Secure Financing</strong>
              TA lacks ability to close in 240-day period ‚Üí Closing Period.
            </div>
          </div>
          <!-- Col 5: 120 days extension -->
          <div class="tl-event-col">
            <div class="tl-event tl-event-if">
              <span class="tag tag-if">OPT</span>
              <strong>TA Financing Extension</strong>
              TA may request extension if pursuing financing with lender letter.
            </div>
            <div class="tl-event tl-event-bad">
              <span class="tag tag-close">‚Üí CLOSE</span>
              <strong>No Lender Letter</strong>
              TA cannot provide letter of financing pursuit ‚Üí Closing Period.
            </div>
          </div>
          <!-- Col 6: closing -->
          <div class="tl-event-col">
            <div class="tl-event tl-event-good">
              <span class="tag tag-then">üè†</span>
              <strong>Tenants Go to Closing</strong>
              TA successfully completes all requirements and closes on the property.
            </div>
          </div>
        </div>
      </div>

      <div class="tl-total">420 DAYS MAX TIMELINE FOR TOPA PROCESS <span>¬∑ Progress bars on each property track all 420 days ¬∑ Properties archived after 420 days ¬∑ Phases may collapse earlier if TA exits</span></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê COMP SIDEBAR ‚ïê‚ïê‚ïê‚ïê -->
<div class="comp-sidebar-panel" id="comp-sidebar-panel">
  <div class="comp-sidebar-hdr">
    <div class="comp-sidebar-hdr-inner">
      <div class="comp-sidebar-title">Sale Comps</div>
      <div class="comp-sidebar-addr" id="comp-sidebar-addr"></div>
    </div>
    <button class="comp-sidebar-close" id="comp-sidebar-close">‚úï</button>
  </div>
  <div class="comp-sidebar-body" id="comp-sidebar-body"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê GITHUB SYNC ‚ïê‚ïê‚ïê‚ïê -->
<button class="gh-sync-btn" id="gh-sync-btn">
  <span class="gh-sync-dot" id="gh-sync-dot"></span>
  ‚Üë Save to GitHub
</button>

<!-- GitHub settings modal -->
<div class="gh-modal-overlay" id="gh-modal-overlay">
  <div class="gh-modal">
    <h3>‚öô GitHub Sync Settings</h3>
    <p>Enter your GitHub repo details and a Personal Access Token with <strong>Contents: Read &amp; Write</strong> permission. These are stored only in your browser.</p>
    <div class="gh-field">
      <label>GitHub Username / Org</label>
      <input type="text" id="gh-owner" placeholder="e.g. johndoe" autocomplete="off">
    </div>
    <div class="gh-field">
      <label>Repository Name</label>
      <input type="text" id="gh-repo" placeholder="e.g. topa-dashboard" autocomplete="off">
    </div>
    <div class="gh-field">
      <label>Branch (usually "main")</label>
      <input type="text" id="gh-branch" placeholder="main" autocomplete="off">
    </div>
    <div class="gh-field">
      <label>Personal Access Token</label>
      <input type="password" id="gh-token" placeholder="github_pat_..." autocomplete="off">
    </div>
    <div id="gh-modal-status" class="gh-status"></div>
    <div class="gh-modal-btns">
      <button class="gh-btn-cancel" id="gh-modal-cancel">Cancel</button>
      <button class="gh-btn-save" id="gh-modal-save">Save Settings</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê STATS MODAL ‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="stats-modal">
  <div class="modal stats-modal-inner">
    <div class="modal-hdr">
      <div>
        <h2>Market Stats</h2>
        <p>Live snapshot of the TOPA pipeline, sale comps, and quadrant activity ‚Äî computed from current data.</p>
      </div>
      <button class="modal-close" id="stats-close">‚úï</button>
    </div>
    <div class="modal-body stats-modal-body" id="stats-modal-body">
      <!-- Populated by JS on open -->
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê IMPORT ‚ïê‚ïê‚ïê‚ïê -->
<button class="import-toggle" id="import-toggle">+ Import TOPA Data</button>

<!-- ‚ïê‚ïê‚ïê‚ïê COMPS IMPORT ‚ïê‚ïê‚ïê‚ïê -->
<button class="comp-toggle" id="comp-toggle">+ Import Sale Comps</button>
<div class="comp-panel" id="comp-panel">
  <h3 style="color:var(--comp);">üè∑ Sales Comps</h3>
  <p>Import closed sales to compare against active TOPA pipeline. Comps can be matched to TOPA properties or stand alone on the map.</p>
  <div class="comp-col-hint">Expected columns (in order):<br>Property Name ¬∑ Property Address ¬∑ Sale Price ¬∑ Sale Date ¬∑ Units ¬∑ Price/Unit ¬∑ Building SF ¬∑ Price/SF ¬∑ Affordable Type ¬∑ Vacancy ¬∑ Year Built ¬∑ PF Cap Rate ¬∑ Actual Cap Rate ¬∑ Building Class ¬∑ Buyer ¬∑ Seller ¬∑ Listing Broker ¬∑ Transaction Notes ¬∑ Age</div>
  <div class="imp-tabs">
    <button class="imp-tab active" data-ctab="cpaste">Paste from Excel</button>
    <button class="imp-tab" data-ctab="ccsv">Upload CSV</button>
    <button class="imp-tab" data-ctab="cmanual">Manual Entry</button>
    <button class="imp-tab" data-ctab="cjson">Load JSON</button>
  </div>
  <div class="imp-content active" id="ctab-cpaste">
    <textarea id="comp-paste-input" placeholder="Paste tab-separated rows from Excel. Header row is auto-detected."></textarea>
    <button class="btn-comp" id="btn-comp-paste-imp">Import Pasted Comps</button>
  </div>
  <div class="imp-content" id="ctab-ccsv">
    <div class="file-drop" id="comp-file-drop"><p id="comp-drop-lbl">Drop CSV here or click to browse</p><input type="file" id="comp-csv-input" accept=".csv,.txt"></div>
    <button class="btn-comp" id="btn-comp-csv-imp">Import CSV</button>
  </div>
  <div class="imp-content" id="ctab-cmanual">
    <div class="comp-form-grid">
      <div class="fg wide"><label>Property Address *</label><input type="text" id="cm-address" placeholder="e.g. 1401 S Street NW"></div>
      <div class="fg wide"><label>Property Name</label><input type="text" id="cm-name" placeholder="Optional deal name"></div>
      <div class="fg"><label>Sale Price ($)</label><input type="number" id="cm-price" placeholder="e.g. 5200000" min="0"></div>
      <div class="fg"><label>Sale Date</label><input type="date" id="cm-date"></div>
      <div class="fg"><label>Units</label><input type="number" id="cm-units" placeholder="# of units" min="0"></div>
      <div class="fg"><label>Building SF</label><input type="number" id="cm-sf" placeholder="Gross SF" min="0"></div>
      <div class="fg"><label>Year Built</label><input type="number" id="cm-year" placeholder="e.g. 1965" min="1800" max="2030"></div>
      <div class="fg"><label>Building Class</label><input type="text" id="cm-class" placeholder="A, B, C..."></div>
      <div class="fg"><label>Actual Cap Rate (%)</label><input type="number" id="cm-cap" placeholder="e.g. 5.2" step="0.01"></div>
      <div class="fg"><label>PF Cap Rate (%)</label><input type="number" id="cm-pfcap" placeholder="e.g. 6.0" step="0.01"></div>
      <div class="fg wide"><label>Buyer</label><input type="text" id="cm-buyer" placeholder="Buying entity"></div>
      <div class="fg wide"><label>Seller</label><input type="text" id="cm-seller" placeholder="Selling entity"></div>
      <div class="fg wide"><label>Listing Broker</label><input type="text" id="cm-broker" placeholder="Listing broker company"></div>
      <div class="fg wide"><label>Affordable Type</label><input type="text" id="cm-aff" placeholder="LIHTC, Market Rate, etc."></div>
      <div class="fg wide"><label>Transaction Notes</label><textarea id="cm-notes" placeholder="Any relevant notes about the transaction..." style="height:56px;"></textarea></div>
    </div>
    <button class="btn-comp" id="btn-comp-manual-add">Add Comp</button>
  </div>
  <div class="imp-content" id="ctab-cjson">
    <p style="font-size:0.68rem;color:var(--muted);margin-bottom:8px;line-height:1.5;">Load a <strong>sales_comps.json</strong> file exported from this dashboard or placed in your GitHub data/ folder. Merges with existing comps ‚Äî duplicates skipped by address+date.</p>
    <div class="file-drop" id="comp-json-drop"><p id="comp-json-lbl">Drop sales_comps.json here or click to browse</p><input type="file" id="comp-json-input" accept=".json"></div>
    <button class="btn-comp" id="btn-comp-json-imp">Load JSON</button>
  </div>
  <button class="btn-comp-outline" id="btn-run-matching" style="margin-top:6px;">üîó Run Address Matching</button>
  <button class="btn-clr" id="btn-clr-comps" style="margin-top:4px;">Clear All Comps Data</button>
  <div style="border-top:1px solid var(--border);margin-top:10px;padding-top:10px;">
    <p style="font-size:0.68rem;color:var(--muted);margin-bottom:6px;line-height:1.5;"><strong>TOPA Properties</strong> ‚Äî drop a properties.json to replace all TOPA data, or clear to start fresh.</p>
    <div class="file-drop" id="props-json-drop"><p id="props-json-lbl">Drop properties.json here or click to browse</p><input type="file" id="props-json-input" accept=".json"></div>
    <button class="btn-comp" id="btn-props-json-imp" style="margin-top:4px;">Load Properties JSON</button>
    <button class="btn-clr" id="btn-clr-props" style="margin-top:4px;">Clear All Properties</button>
  </div>
  <div class="comp-imp-msg" id="comp-imp-msg"></div>
  <!-- Loaded comps list -->
  <div id="comp-panel-list-wrap" style="margin-top:12px;border-top:1px solid var(--border);padding-top:10px;display:none;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
      <span style="font-size:0.7rem;font-weight:700;color:var(--navy);">Loaded Comps <span class="comp-cnt-badge" id="comp-cnt-badge">0</span></span>
      <button class="btn-comp-export" id="btn-export-comps" title="Export comps as JSON">‚Üì Export Comps</button>
      <button class="btn-comp-export" id="btn-export-props" title="Export properties as JSON" style="margin-left:4px;">‚Üì Export Properties</button>
    </div>
    <div id="comps-sidebar-list" style="max-height:240px;overflow-y:auto;"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê COMP MATCH MODAL ‚ïê‚ïê‚ïê‚ïê -->
<div class="match-modal" id="match-modal">
  <div class="match-box">
    <div class="match-hdr">
      <div>
        <h2>Address Matching</h2>
        <p class="match-progress" id="match-progress-lbl">Review possible matches between sale comps and TOPA properties.</p>
      </div>
      <button class="modal-close" id="match-close" style="background:rgba(255,255,255,0.15);">‚úï</button>
    </div>
    <div class="match-body" id="match-body">
      <!-- Populated by JS -->
    </div>
    <div style="padding:0 24px 20px;display:flex;gap:10px;">
      <button class="match-btn-accept" id="match-btn-accept" style="background:#16a34a;">‚úì Accept This Match</button>
      <button class="match-btn-skip" id="match-btn-skip">Skip (No Match)</button>
      <button class="match-btn-skip" id="match-btn-done" style="display:none;background:var(--comp);color:white;border-color:var(--comp);">Done</button>
    </div>
  </div>
</div>


<div class="import-panel" id="import-panel">
  <h3>Import Properties</h3>
  <p>Append new properties via CSV or paste from Excel. Existing data is always preserved.</p>
  <div class="col-hint">Expected columns (in order):<br>TOPA Date ¬∑ Address ¬∑ Deal Name ¬∑ Type ¬∑ Units ¬∑ Price ¬∑ Price/Unit ¬∑ FOIA ¬∑ Buyer ¬∑ Owner</div>
  <div class="imp-tabs">
    <button class="imp-tab active" data-tab="paste">Paste from Excel</button>
    <button class="imp-tab" data-tab="csv">Upload CSV</button>
  </div>
  <div class="imp-content active" id="tab-paste">
    <textarea id="paste-input" placeholder="Paste tab-separated rows from Excel. Header row is auto-detected."></textarea>
    <button class="btn-imp" id="btn-paste-imp">Import Pasted Data</button>
  </div>
  <div class="imp-content" id="tab-csv">
    <div class="file-drop" id="file-drop"><p id="drop-lbl">Drop CSV here or click to browse</p><input type="file" id="csv-input" accept=".csv,.txt"></div>
    <button class="btn-imp" id="btn-csv-imp">Import CSV</button>
  </div>
  <button class="btn-clr" id="btn-clr-all">Clear All Imported Data</button>
  <div class="imp-msg" id="imp-msg"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
var GEO = {}; // coordinates cached in localStorage

// TOPA milestone thresholds (cumulative days)
var MILESTONES = [
  {day:5,   label:"Tenants Notified"},
  {day:50,  label:"TA Formation Window (45d)"},
  {day:185, label:"TA Contract & Deposit (135d)"},
  {day:305, label:"TA Secure Financing (120d)"},
  {day:420, label:"TA Financing Extension (120d)"},
];

var BASE_DATA = [];

var TODAY = new Date(); TODAY.setHours(0,0,0,0);
var TOPA_LIMIT = 420;
var allData = BASE_DATA.map(function(p,i){ var o=Object.assign({},p); o._idx=i; return o; });
var importedData = [];
var filteredData = [];
var activeType = 'all';
var showingArchive = false;
var markers = [];
var _markerGen = 0; // increments each render; lets stale async loops self-abort
var dcLayer = null;
var map;

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function daysIn(dateStr){ if(!dateStr) return 0; var d=new Date(dateStr); d.setHours(0,0,0,0); return Math.floor((TODAY-d)/86400000); }
function isArc(p){ return daysIn(p.date)>TOPA_LIMIT && getCompsForTopa(p._idx).length===0; }
function fmt$(n){ if(n==null||isNaN(n)) return '‚Äî'; if(n>=1e9) return '$'+(n/1e9).toFixed(2)+'B'; if(n>=1e6) return '$'+(n/1e6).toFixed(n%1e6===0?0:1)+'M'; if(n>=1000) return '$'+Math.round(n/1000)+'K'; return '$'+n.toLocaleString(); }
function fmtFull$(n){ return (n==null||isNaN(n))?'‚Äî':'$'+n.toLocaleString(); }
function getPPU(p){ return (p.price&&p.units)?Math.round(p.price/p.units):null; }
function fmtDate(s){ if(!s) return '‚Äî'; var pt=s.split('-'); var mo=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; return mo[parseInt(pt[1])-1]+' '+parseInt(pt[2])+', '+pt[0]; }

function getMilestonePhase(days){
  if(days<=5) return {phase:0,label:"Tenants Notified"};
  if(days<=50) return {phase:1,label:"TA Formation Window"};
  if(days<=185) return {phase:2,label:"TA Contract & Deposit"};
  if(days<=305) return {phase:3,label:"TA Securing Financing"};
  if(days<=420) return {phase:4,label:"TA Financing Extension"};
  return {phase:5,label:"Process Concluded"};
}

function getActiveMostRecent(){
  var active=allData.filter(function(p){return !isArc(p);});
  if(!active.length) return allData.reduce(function(a,b){return a.date>b.date?a:b;}).date;
  return active.reduce(function(a,b){return a.date>b.date?a:b;}).date;
}

// ‚îÄ‚îÄ MAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initMap(){
  map=L.map('map',{center:[38.9072,-77.0369],zoom:12});
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{attribution:'¬© OpenStreetMap ¬© CARTO',maxZoom:19}).addTo(map);
  // DC boundary via GeoJSON
  fetch('https://raw.githubusercontent.com/unitedstates/districts/gh-pages/states/DC/shape.geojson')
    .then(function(r){return r.json();})
    .then(function(data){
      dcLayer=L.geoJSON(data,{
        style:{color:'#081937',weight:3.5,fillOpacity:0,opacity:0.9}
      }).addTo(map);
    }).catch(function(){});
}

// ‚îÄ‚îÄ GEOCODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Load any previously cached coords from localStorage
(function(){
  try{var s=localStorage.getItem('topa_geo');if(s){var c=JSON.parse(s);Object.assign(GEO,c);}}catch(e){}
})();

function saveGeoCache(){
  try{localStorage.setItem('topa_geo',JSON.stringify(GEO));}catch(e){}
}

async function geocode(addr){
  if(GEO[addr]) return GEO[addr];
  // Try progressively simplified versions of the address
  var attempts = [
    addr + ', Washington DC',
    addr + ', Washington, DC',
    addr.replace(/\s*&\s*/g, ' and ') + ', Washington DC',
    // Strip everything after the first comma (drop suite/unit info)
    addr.split(',')[0].trim() + ', Washington DC',
    // For multi-address strings like "123 & 125 Main St NW", just use the first number
    addr.replace(/^(\d+[\w-]*)\s*[,&\/].*?((?:Street|St|Avenue|Ave|Road|Rd|Place|Pl|Drive|Dr|Boulevard|Blvd|Lane|Ln|Court|Ct|Way|Terrace|Ter|Circle|Cir|NW|NE|SW|SE)\b.*)/i, '$1 $2') + ', Washington DC'
  ];
  for(var i=0; i<attempts.length; i++){
    try{
      var r=await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(attempts[i])+'&limit=1');
      var d=await r.json();
      if(d&&d[0]){
        var c=[parseFloat(d[0].lat),parseFloat(d[0].lon)];
        GEO[addr]=c;
        saveGeoCache();
        return c;
      }
    }catch(e){}
  }
  console.warn('[TOPA] geocode failed for:', addr);
  return null;
}

// ‚îÄ‚îÄ MARKERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderMarkers(){
  markers.forEach(function(m){map.removeLayer(m);});
  markers=[];
  for(var i=0;i<filteredData.length;i++){
    var p=filteredData[i];
    var coords=await geocode(p.address);
    if(!coords) continue;
    var arc=isArc(p); var isC=p.type==='w/ Contract';
    var color=arc?'#94a3b8':(isC?'#16a34a':'#dc2626');
    var days=daysIn(p.date); var ppuVal=getPPU(p);
    var pct=Math.min(100,Math.round(days/TOPA_LIMIT*100));
    // Segmented bar for popup
    var segsThresh=[5,50,185,305,420];
    var segColors=['#16a34a','#22c55e','#d97706','#ea580c','#dc2626'];
    var popSegHtml=segsThresh.map(function(t,si){
      var filled=days>=t; 
      return '<div style="flex:1;height:4px;border-radius:1px;background:'+(filled?segColors[si]:'rgba(255,255,255,0.15)')+'"></div>';
    }).join('');
    var ms=getMilestonePhase(days);

    var msHtml='';
    MILESTONES.forEach(function(m,mi){
      var cls=days>m.day?'past':(days>=(mi>0?MILESTONES[mi-1].day:0)&&days<=m.day?'current':'future');
      msHtml+='<div class="pu-ms-row"><div class="pu-ms-dot '+cls+'"></div><span class="pu-ms-lbl'+(cls==='current'?' current':'')+'">'+m.label+'</span><span class="pu-ms-days">Day '+m.day+'</span></div>';
    });

    var html='<div class="pu-addr">'+p.address+'</div>'
      +(p.name?'<div class="pu-name">'+p.name+'</div>':'')
      +'<div class="pu-grid">'
      +'<div class="pu-f"><label>TOPA Date</label><span>'+fmtDate(p.date)+'</span></div>'
      +'<div class="pu-f"><label>Units</label><span>'+p.units+'</span></div>'
      +'<div class="pu-f"><label>Price</label><span>'+fmtFull$(p.price)+'</span></div>'
      +'<div class="pu-f"><label>Price / Unit</label><span>'+(ppuVal?'$'+ppuVal.toLocaleString():'‚Äî')+'</span></div>'
      +(p.buyer?'<div class="pu-f wide"><label>Buyer</label><span>'+p.buyer+'</span></div>':'')
      +(p.owner?'<div class="pu-f wide"><label>Owner / Seller</label><span>'+p.owner+'</span></div>':'')
      +'<div class="pu-f"><label>FOIA</label><span>'+(p.foia||'‚Äî')+'</span></div>'
      +'</div>'
      +'<div class="pu-tags"><span class="pu-tag '+(arc?'arc':(isC?'c':'nc'))+'">'+p.type+'</span></div>'
      +'<div class="pu-topa-bar">'
      +'<div class="pu-topa-lbl">TOPA Progress ¬∑ <strong style="color:white">'+ms.label+'</strong></div>'
      +'<div style="display:flex;gap:2px;margin:5px 0 4px">'+ popSegHtml +'</div>'
      +'<div style="display:flex;justify-content:space-between;font-size:0.6rem;color:rgba(255,255,255,0.38)">'
      +'<span>Day 0</span><span>45</span><span>185</span><span>305</span><span>420</span>'
      +'</div>'
      +'<div class="pu-topa-info" style="margin-top:5px"><strong>'+days+' days</strong><span>'+(arc?'Archived':Math.max(0,TOPA_LIMIT-days)+' days left')+'</span></div>'
      +'</div>'
      +'<div class="pu-milestones" style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.1)">'
      +'<div style="font-size:0.55rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.38);margin-bottom:5px">Current Phase</div>'
      +'<div style="font-size:0.75rem;font-weight:700;color:white">'+ms.label+'</div>'
      +'</div>';

    (function(idx){
      var opacity=arc?'0.5':'1';
      var icon=L.divIcon({
        className:'',
        html:'<div style="width:16px;height:16px;border-radius:50%;background:'+color+';border:2.5px solid white;box-shadow:0 1px 4px rgba(0,0,0,0.35);opacity:'+opacity+';cursor:pointer;"></div>',
        iconSize:[16,16],iconAnchor:[8,8],popupAnchor:[0,-10]
      });
      var mk=L.marker(coords,{icon:icon}).bindPopup(html,{maxWidth:310});
      mk.on('click',function(){hlItem(idx);});
      mk.addTo(map);
      markers.push(mk);
    })(i);
  }
}

// ‚îÄ‚îÄ LIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderList(){
  var el=document.getElementById('prop-list');
  var cnt=document.getElementById('res-count');
  var lbl=showingArchive?'archived ':'';

  // Build mixed list: TOPA properties + comps interleaved
  var items=[];
  filteredData.forEach(function(p,i){
    var arc=isArc(p);
    var compsList=getCompsForTopa(p._idx);
    var hasComps=compsList.length>0;
    var markerColor=hasComps?'#d97706':(arc?'#94a3b8':'#059669');
    items.push({kind:'topa',p:p,i:i,color:markerColor,compsList:compsList});
    // Show matched comp rows beneath the TOPA property
    // In archive view, only show comps whose linked TOPA is also archived
    compsList.forEach(function(c){
      var linkedProp = allData[c.topaId];
      if(showingArchive && linkedProp && !isArc(linkedProp)) return;
      items.push({kind:'comp',c:c,ci:compsData.indexOf(c),color:'#d97706'});
    });
  });
  // Unmatched comps at the bottom ‚Äî only in non-archive view
  if(!showingArchive){
    compsData.filter(function(c){ return c.topaId===null||c.topaId===undefined; }).forEach(function(c){
      items.push({kind:'comp',c:c,ci:compsData.indexOf(c),color:'#7c3aed'});
    });
  }

  var topaCount=filteredData.length;
  var shownComps=compsData.length;
  cnt.textContent=topaCount+' '+lbl+'propert'+(topaCount===1?'y':'ies')+(shownComps&&!showingArchive?' ¬∑ '+shownComps+' comp'+(shownComps===1?'':' s'):'');

  if(!items.length){
    el.innerHTML='<div class="no-res">'+(showingArchive?'No archived properties yet. These appear once a TOPA date is more than 420 days ago.':'No properties match the current filters.')+'</div>';
    return;
  }

  el.innerHTML=items.map(function(item){
    if(item.kind==='topa'){
      var p=item.p; var i=item.i;
      var ppuVal=getPPU(p); var arc=isArc(p);
      var days=daysIn(p.date);
      var compsList=item.compsList;
      var sold=compsList.length>0 && compsList[0].date;
      var soldDate=sold?compsList[0].date:null;
      var daysAtSale=sold?Math.max(0,Math.round((new Date(soldDate)-new Date(p.date))/86400000)):days;
      var segs=[5,50,185,305,420];
      var segHtml;
      if(sold){
        segHtml=segs.map(function(){ return '<div class="days-seg" style="background:#d97706"></div>'; }).join('');
      } else {
        segHtml=segs.map(function(threshold,si){
          var cls=days>=threshold?'filled-'+(si+1):'';
          return '<div class="days-seg '+cls+'"></div>';
        }).join('');
      }
      var ms=getMilestonePhase(days);
      var phaseLabel=sold?'‚úì Sold ‚Äî Process Complete':ms.label;
      var daysLabel=sold?'<strong>'+daysAtSale+'d</strong> in TOPA':'<strong>'+days+'d</strong> in TOPA';
      var rightLabel=sold
        ?'<span style="color:#d97706;font-weight:700;">Sold ¬∑ '+fmtDate(soldDate)+'</span>'
        :(arc?'<span class="bdg bdg-arc">Archived</span>':'<span>'+Math.max(0,TOPA_LIMIT-days)+'d left</span>');
      return '<div class="pi'+(arc?' arc':'')+'" data-idx="'+i+'" onclick="focusProp('+i+')" style="border-left:3px solid '+item.color+';"> '
        +'<div class="pi-addr">'+p.address+'</div>'
        +(p.name?'<div class="pi-name">'+p.name+'</div>':'')+
        '<div class="pi-meta">'
        +'<span class="bdg bdg-n">'+p.units+' units</span>'
        +(ppuVal?'<span class="bdg bdg-gr">'+fmt$(ppuVal)+'/unit</span>':'')+
        '<span class="pi-price">'+fmt$(p.price)+'</span>'
        +'</div>'
        +'<div class="pi-days">'+daysLabel
        +'<span class="days-bar">'+segHtml+'</span>'
        +rightLabel
        +'</div>'
        +'<div class="pi-phase">'+phaseLabel+'</div>'
        +'</div>';
    } else {
      var c=item.c; var ci=item.ci;
      var ppu=(c.price&&c.units)?Math.round(c.price/c.units):c.ppu;
      var matched=(c.topaId!==null&&c.topaId!==undefined);
      return '<div class="pi pi-comp" onclick="focusComp('+ci+')" style="border-left:3px solid '+item.color+';background:rgba(124,58,237,0.04);">'
        +'<div style="font-size:0.52rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:'+(matched?'#d97706':'#7c3aed')+';margin-bottom:2px;">'+(matched?'‚ñ∏ SALE COMP':'‚ó¶ SALE COMP (unmatched)')+'</div>'
        +'<div class="pi-addr" style="font-size:0.72rem;">'+(c.name||c.address)+'</div>'
        +(c.name?'<div class="pi-name">'+c.address+'</div>':'')+
        '<div class="pi-meta">'
        +(c.date?'<span class="bdg bdg-n">'+fmtDate(c.date)+'</span>':'')+
        (c.units?'<span class="bdg bdg-n">'+c.units+' units</span>':'')+
        (ppu?'<span class="bdg bdg-gr">'+fmt$(ppu)+'/unit</span>':'')+
        (c.price?'<span class="pi-price">'+fmt$(c.price)+'</span>':'')+
        '</div>'
        +'</div>';
    }
  }).join('');
}

// ‚îÄ‚îÄ STATS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateStats(){
  var active=allData.filter(function(p){return !isArc(p);});
  var u=active.reduce(function(s,p){return s+(p.units||0);},0);
  var v=active.reduce(function(s,p){return s+(p.price||0);},0);
  var pa=active.filter(function(p){return p.price&&p.units;}).map(function(p){return p.price/p.units;});
  var avgPpu=pa.length?pa.reduce(function(a,b){return a+b;},0)/pa.length:null;
  document.getElementById('stat-props').textContent=active.length;
  document.getElementById('stat-units').textContent=u.toLocaleString();
  document.getElementById('stat-vol').textContent=fmt$(v);
  document.getElementById('stat-ppu').textContent=avgPpu?'$'+Math.round(avgPpu).toLocaleString():'‚Äî';
  document.getElementById('arc-cnt').textContent=allData.filter(function(p){return isArc(p);}).length;
  document.getElementById('asof-date').textContent=fmtDate(getActiveMostRecent());
}

// ‚îÄ‚îÄ FILTER + SORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applyFilters(){
  var foia=document.getElementById('filter-foia').value;
  var sort=document.getElementById('sort-by').value;
  var uMin=parseFloat(document.getElementById('u-min').value)||null;
  var uMax=parseFloat(document.getElementById('u-max').value)||null;
  var pMin=parseFloat(document.getElementById('p-min').value)||null;
  var pMax=parseFloat(document.getElementById('p-max').value)||null;
  var ppuMin=parseFloat(document.getElementById('ppu-min').value)||null;
  var ppuMax=parseFloat(document.getElementById('ppu-max').value)||null;
  var dMin=document.getElementById('d-min').value||null;
  var dMax=document.getElementById('d-max').value||null;
  var daysMinV=document.getElementById('days-min').value;
  var daysMaxV=document.getElementById('days-max').value;
  var searchTerm = (document.getElementById('prop-search').value||'').toLowerCase().trim();
  var pool=allData.filter(function(p){
    if(showingArchive ? !isArc(p) : isArc(p)) return false;
    if(searchTerm){
      var hay = ((p.address||'')+' '+(p.name||'')).toLowerCase();
      if(!hay.includes(searchTerm)) return false;
    }
    return true;
  });
  filteredData=pool.filter(function(p){
    if(activeType!=='all'&&p.type!==activeType) return false;
    if(foia&&p.foia!==foia) return false;
    if(uMin!=null&&p.units<uMin) return false;
    if(uMax!=null&&p.units>uMax) return false;
    if(pMin!=null&&(p.price==null||p.price<pMin)) return false;
    if(pMax!=null&&(p.price==null||p.price>pMax)) return false;
    var pp=getPPU(p);
    if(ppuMin!=null&&(pp==null||pp<ppuMin)) return false;
    if(ppuMax!=null&&(pp==null||pp>ppuMax)) return false;
    if(dMin&&p.date<dMin) return false;
    if(daysMinV&&daysIn(p.date)<parseInt(daysMinV)) return false;
    if(daysMaxV&&daysIn(p.date)>parseInt(daysMaxV)) return false;
    if(dMax&&p.date>dMax) return false;
    return true;
  });
  filteredData.sort(function(a,b){
    switch(sort){
      case 'date-desc': return b.date.localeCompare(a.date);
      case 'date-asc': return a.date.localeCompare(b.date);
      case 'days-desc': return daysIn(b.date)-daysIn(a.date);
      case 'days-asc': return daysIn(a.date)-daysIn(b.date);
      case 'price-desc': return (b.price||0)-(a.price||0);
      case 'price-asc': return (a.price||0)-(b.price||0);
      case 'units-desc': return (b.units||0)-(a.units||0);
      case 'units-asc': return (a.units||0)-(b.units||0);
      case 'ppu-desc': return (getPPU(b)||0)-(getPPU(a)||0);
      case 'ppu-asc': return (getPPU(a)||0)-(getPPU(b)||0);
      default: return 0;
    }
  });
  updateStats(); renderList(); renderMarkers();
}

// ‚îÄ‚îÄ FOCUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function focusProp(idx){
  document.querySelectorAll('.pi').forEach(function(e){e.classList.remove('hl');});
  var el=document.querySelector('.pi[data-idx="'+idx+'"]');
  if(el) el.classList.add('hl');
  var p=filteredData[idx];
  var coords=await geocode(p.address);
  if(!coords) return;
  clearTimeout(window._popupTimer);
  clearInterval(window._markerPoll);
  map.flyTo(coords,16,{animate:true,duration:0.8});
  // Wait for fly animation to finish (0.8s + buffer), then poll for marker
  window._popupTimer=setTimeout(function(){
    var attempts=0;
    window._markerPoll=setInterval(function(){
      attempts++;
      if(p._marker){ clearInterval(window._markerPoll); p._marker.openPopup(); return; }
      if(attempts>30){ clearInterval(window._markerPoll); } // give up after 3s
    },100);
  },950);
}
function hlItem(idx){
  document.querySelectorAll('.pi').forEach(function(e){e.classList.remove('hl');});
  var el=document.querySelector('.pi[data-idx="'+idx+'"]');
  if(el){el.classList.add('hl');el.scrollIntoView({behavior:'smooth',block:'nearest'});}
}

// ‚îÄ‚îÄ EVENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('#chips-type .chip').forEach(function(chip){
  chip.addEventListener('click',function(){
    document.querySelectorAll('#chips-type .chip').forEach(function(c){c.classList.remove('active');});
    chip.classList.add('active'); activeType=chip.dataset.val; applyFilters();
  });
});
['filter-foia','sort-by','d-min','d-max'].forEach(function(id){document.getElementById(id).addEventListener('change',applyFilters);});
['u-min','u-max','p-min','p-max','ppu-min','ppu-max','days-min','days-max'].forEach(function(id){
  document.getElementById(id).addEventListener('input',function(){clearTimeout(window._ft);window._ft=setTimeout(applyFilters,350);});
});
// Search bar
(function(){
  var inp = document.getElementById('prop-search');
  var clr = document.getElementById('search-clear');
  inp.addEventListener('input', function(){
    clr.classList.toggle('visible', inp.value.length > 0);
    clearTimeout(window._st); window._st = setTimeout(applyFilters, 200);
  });
  clr.addEventListener('click', function(){
    inp.value = ''; clr.classList.remove('visible'); applyFilters();
  });
})();

document.getElementById('btn-reset').addEventListener('click',function(){
  activeType='all';
  document.querySelectorAll('#chips-type .chip').forEach(function(c){c.classList.remove('active');});
  document.querySelector('#chips-type .chip[data-val="all"]').classList.add('active');
  document.getElementById('filter-foia').value='';
  document.getElementById('sort-by').value='date-desc';
  ['u-min','u-max','p-min','p-max','ppu-min','ppu-max','d-min','d-max','days-min','days-max'].forEach(function(id){document.getElementById(id).value='';});
  document.getElementById('prop-search').value=''; document.getElementById('search-clear').classList.remove('visible');
  applyFilters();
});

// Archive
document.getElementById('btn-archive').addEventListener('click',function(){
  showingArchive=true; this.classList.add('active');
  document.getElementById('arc-banner').classList.add('on'); applyFilters();
});
document.getElementById('arc-close').addEventListener('click',function(){
  showingArchive=false; document.getElementById('btn-archive').classList.remove('active');
  document.getElementById('arc-banner').classList.remove('on'); applyFilters();
});

// Timeline modal
document.getElementById('btn-stats').addEventListener('click', openStatsModal);
document.getElementById('stats-close').addEventListener('click',function(){document.getElementById('stats-modal').classList.remove('open');});
document.getElementById('stats-modal').addEventListener('click',function(e){if(e.target===this)this.classList.remove('open');});

function openStatsModal(){
  document.getElementById('stats-modal').classList.add('open');
  renderStatsModal();
}

function renderStatsModal(){
  var active = allData.filter(function(p){ return !isArc(p); });
  var archived = allData.filter(function(p){ return isArc(p); });
  var sold = allData.filter(function(p){ return getCompsForTopa(p._idx).length > 0; });
  var matched = compsData.filter(function(c){ return c.topaId !== null && c.topaId !== undefined; });

  // KPIs
  var totalUnits = active.reduce(function(s,p){ return s+(p.units||0); }, 0);
  var totalVol = active.reduce(function(s,p){ return s+(p.price||0); }, 0);
  var ppuArr = active.filter(function(p){ return p.price&&p.units; }).map(function(p){ return p.price/p.units; });
  var avgPpu = ppuArr.length ? ppuArr.reduce(function(a,b){ return a+b; },0)/ppuArr.length : null;
  function median(arr){ if(!arr.length) return null; var s=arr.slice().sort(function(a,b){return a-b;}); var m=Math.floor(s.length/2); return s.length%2?s[m]:(s[m-1]+s[m])/2; }
  var medPpu = median(ppuArr);

  // Comp KPIs
  var compPpuArr = compsData.filter(function(c){ return c.price&&c.units; }).map(function(c){ return c.price/c.units; });
  var avgCompPpu = compPpuArr.length ? compPpuArr.reduce(function(a,b){return a+b;},0)/compPpuArr.length : null;
  var medCompPpu = median(compPpuArr);
  var compsWithUnits = compsData.filter(function(c){ return c.units; });
  var avgCompUnits = compsWithUnits.length ? Math.round(compsWithUnits.reduce(function(s,c){ return s+(c.units||0); }, 0) / compsWithUnits.length) : null;

  // Oldest sale comp that has a TOPA match
  var matchedCompsWithDates = matched.filter(function(c){ return c.date; }).sort(function(a,b){ return a.date.localeCompare(b.date); });
  var oldestCompDate = matchedCompsWithDates.length ? fmtDate(matchedCompsWithDates[0].date) : null;

  // Quadrant breakdown
  var quads = {NW:0, NE:0, SW:0, SE:0, other:0};
  active.forEach(function(p){
    var m = (p.address||'').match(/\b(NW|NE|SW|SE)\b/i);
    if(m) quads[m[1].toUpperCase()]++;
    else quads.other++;
  });
  var maxQ = Math.max(quads.NW, quads.NE, quads.SW, quads.SE, quads.other, 1);

  // Phase breakdown (active unsold)
  var unsold = active.filter(function(p){ return getCompsForTopa(p._idx).length === 0; });
  var phases = [0,0,0,0,0];
  unsold.forEach(function(p){
    var d = daysIn(p.date);
    if(d < 5) phases[0]++;
    else if(d < 50) phases[1]++;
    else if(d < 185) phases[2]++;
    else if(d < 305) phases[3]++;
    else phases[4]++;
  });
  var phaseLabels = ['< 5d','5‚Äì50d','50‚Äì185d','185‚Äì305d','305‚Äì420d'];
  var phaseNames = ['Just Posted','TA Formation','TA Contract','TA Financing','Extension'];
  var phaseColors = ['#16a34a','#22c55e','#d97706','#ea580c','#dc2626'];

  // Days-in-TOPA for SOLD properties (days from TOPA date to sale comp date)
  var soldDays = [];
  sold.forEach(function(p){
    var cs = getCompsForTopa(p._idx);
    if(cs.length && cs[0].date && p.date){
      var d = Math.max(0, Math.round((new Date(cs[0].date) - new Date(p.date)) / 86400000));
      soldDays.push(d);
    }
  });
  var avgSoldDays = soldDays.length ? Math.round(soldDays.reduce(function(a,b){return a+b;},0)/soldDays.length) : null;
  var medSoldDays = soldDays.length ? Math.round(median(soldDays)) : null;
  var maxSoldDays = soldDays.length ? Math.max.apply(null, soldDays) : null;

  // Unit size buckets
  var unitBuckets = [
    {lbl:'5‚Äì10',min:5,max:10,n:0},
    {lbl:'10‚Äì25',min:10,max:25,n:0},
    {lbl:'25‚Äì75',min:25,max:75,n:0},
    {lbl:'75‚Äì150',min:75,max:150,n:0},
    {lbl:'150+',min:150,max:Infinity,n:0}
  ];
  active.forEach(function(p){
    var u=p.units||0;
    for(var i=0;i<unitBuckets.length;i++){
      if(u>=unitBuckets[i].min && u<unitBuckets[i].max){ unitBuckets[i].n++; break; }
    }
  });
  var maxU = Math.max.apply(null, unitBuckets.map(function(b){return b.n;}).concat([1]));

  // Contract type
  var withContract = active.filter(function(p){ return p.type==='w/ Contract'; }).length;
  var withoutContract = active.length - withContract;

  var html =
    '<div class="stats-section-lbl">Pipeline Overview</div>'+
    '<div class="stats-kpi-row">'+
      '<div class="stats-kpi accent"><div class="kv">'+active.length+'</div><div class="kl">Active TOPAs</div></div>'+
      '<div class="stats-kpi"><div class="kv">'+totalUnits.toLocaleString()+'</div><div class="kl">Units in TOPA</div></div>'+
      '<div class="stats-kpi"><div class="kv">'+fmt$(totalVol)+'</div><div class="kl">Volume in TOPA</div></div>'+
      '<div class="stats-kpi gold"><div class="kv">'+sold.length+'</div><div class="kl">Buildings TOPA Completed and Sold '+(oldestCompDate?'<span style="font-weight:500;font-size:0.9em">* since '+oldestCompDate+'</span>':'')+'</div></div>'+
      '<div class="stats-kpi"><div class="kv">'+archived.length+'</div><div class="kl">TOPA Contracts with No Sale</div></div>'+
    '</div>'+

    '<div class="stats-section-lbl" style="margin-top:20px">Pricing</div>'+
    '<div class="stats-kpi-row">'+
      '<div class="stats-kpi"><div class="kv">'+( avgPpu?'$'+Math.round(avgPpu).toLocaleString():'‚Äî')+'</div><div class="kl">Avg Contract $/Unit</div></div>'+
      '<div class="stats-kpi"><div class="kv">'+( medPpu?'$'+Math.round(medPpu).toLocaleString():'‚Äî')+'</div><div class="kl">Median Contract $/Unit</div></div>'+
      '<div class="stats-kpi gold"><div class="kv">'+( avgCompPpu?'$'+Math.round(avgCompPpu).toLocaleString():'‚Äî')+'</div><div class="kl">Avg Sale $/Unit</div></div>'+
      '<div class="stats-kpi gold"><div class="kv">'+( medCompPpu?'$'+Math.round(medCompPpu).toLocaleString():'‚Äî')+'</div><div class="kl">Median Sale $/Unit</div></div>'+
      '<div class="stats-kpi"><div class="kv">'+(avgCompUnits||'‚Äî')+'</div><div class="kl">Avg Units (Sales)</div></div>'+
    '</div>'+

    '<div class="stats-section-lbl" style="margin-top:20px">Active Pipeline ‚Äî Phase Breakdown</div>'+
    '<div class="stats-phase-row">'+
    phases.map(function(n,i){
      return '<div class="stats-phase-card">'+
        '<div class="pv">'+n+'</div>'+
        '<div class="pl">'+phaseNames[i]+'<br>'+phaseLabels[i]+'</div>'+
        '<div class="pb" style="background:'+phaseColors[i]+'"></div>'+
      '</div>';
    }).join('')+
    '</div>'+

    '<div class="stats-two-col" style="margin-top:16px">'+

      // Quadrant
      '<div class="stats-bar-group">'+
        '<div class="stats-bar-group-title">Active TOPAs by Quadrant</div>'+
        ['NW','NE','SW','SE'].map(function(q){
          var pct = Math.round(quads[q]/maxQ*100);
          return '<div class="stats-bar-row">'+
            '<div class="stats-bar-lbl">'+q+'</div>'+
            '<div class="stats-bar-track"><div class="stats-bar-fill" style="width:'+pct+'%;background:var(--accent)"></div></div>'+
            '<div class="stats-bar-val">'+quads[q]+'</div>'+
          '</div>';
        }).join('')+
        (quads.other?'<div class="stats-bar-row"><div class="stats-bar-lbl">‚Äî</div><div class="stats-bar-track"><div class="stats-bar-fill" style="width:'+Math.round(quads.other/maxQ*100)+'%;background:var(--muted)"></div></div><div class="stats-bar-val">'+quads.other+'</div></div>':'')+
      '</div>'+

      // Unit size
      '<div class="stats-bar-group">'+
        '<div class="stats-bar-group-title">Active TOPAs by Building Size (Units)</div>'+
        unitBuckets.map(function(b){
          var pct = Math.round(b.n/maxU*100);
          return '<div class="stats-bar-row">'+
            '<div class="stats-bar-lbl" style="width:55px">'+b.lbl+'</div>'+
            '<div class="stats-bar-track"><div class="stats-bar-fill" style="width:'+pct+'%;background:#059669"></div></div>'+
            '<div class="stats-bar-val">'+b.n+'</div>'+
          '</div>';
        }).join('')+
      '</div>'+

    '</div>'+

    '<div class="stats-two-col" style="margin-top:12px">'+

      // Days to sale for sold properties
      '<div class="stats-bar-group">'+
        '<div class="stats-bar-group-title">Days in TOPA Before Sale ‚Äî '+sold.length+' Completed Properties</div>'+
        (soldDays.length
          ? '<div style="display:flex;gap:20px;margin-bottom:10px">'+
              '<div><div style="font-size:1.2rem;font-weight:800;color:var(--navy)">'+avgSoldDays+'d</div><div style="font-size:0.58rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted);font-weight:700">Average</div></div>'+
              '<div><div style="font-size:1.2rem;font-weight:800;color:var(--navy)">'+medSoldDays+'d</div><div style="font-size:0.58rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted);font-weight:700">Median</div></div>'+
              '<div><div style="font-size:1.2rem;font-weight:800;color:var(--navy)">'+maxSoldDays+'d</div><div style="font-size:0.58rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted);font-weight:700">Longest</div></div>'+
            '</div>'+
            '<div style="height:6px;background:var(--border);border-radius:3px;overflow:hidden;margin-bottom:4px">'+
              '<div style="height:100%;border-radius:3px;background:linear-gradient(90deg,#16a34a,#d97706,#dc2626);width:100%"></div>'+
            '</div>'+
            '<div style="display:flex;justify-content:space-between;font-size:0.55rem;color:var(--muted)"><span>Day 0</span><span>Day 210</span><span>Day 420</span></div>'
          : '<div style="font-size:0.75rem;color:var(--muted);padding:16px 0">No sold properties with matched comps yet.</div>')+
      '</div>'+

      // Contract type + comp matching
      '<div class="stats-bar-group">'+
        '<div class="stats-bar-group-title">Contract Type &amp; Comp Coverage</div>'+
        '<div class="stats-bar-row">'+
          '<div class="stats-bar-lbl wide">w/ Contract</div>'+
          '<div class="stats-bar-track"><div class="stats-bar-fill" style="width:'+Math.round(withContract/Math.max(active.length,1)*100)+'%;background:var(--accent)"></div></div>'+
          '<div class="stats-bar-val wide">'+withContract+' / '+active.length+'</div>'+
        '</div>'+
        '<div class="stats-bar-row">'+
          '<div class="stats-bar-lbl wide">No Contract</div>'+
          '<div class="stats-bar-track"><div class="stats-bar-fill" style="width:'+Math.round(withoutContract/Math.max(active.length,1)*100)+'%;background:#94a3b8"></div></div>'+
          '<div class="stats-bar-val wide">'+withoutContract+' / '+active.length+'</div>'+
        '</div>'+
        '<div class="stats-bar-row" style="margin-top:8px">'+
          '<div class="stats-bar-lbl wide">Comps Matched</div>'+
          '<div class="stats-bar-track"><div class="stats-bar-fill" style="width:'+Math.round(matched.length/Math.max(compsData.length,1)*100)+'%;background:#d97706"></div></div>'+
          '<div class="stats-bar-val wide">'+matched.length+' / '+compsData.length+'</div>'+
        '</div>'+
        '<div class="stats-bar-row">'+
          '<div class="stats-bar-lbl wide">Unmatched</div>'+
          '<div class="stats-bar-track"><div class="stats-bar-fill" style="width:'+Math.round((compsData.length-matched.length)/Math.max(compsData.length,1)*100)+'%;background:#e5e7eb"></div></div>'+
          '<div class="stats-bar-val wide">'+( compsData.length-matched.length)+' / '+compsData.length+'</div>'+
        '</div>'+
      '</div>'+

    '</div>';

  document.getElementById('stats-modal-body').innerHTML = html;
}

document.getElementById('btn-timeline').addEventListener('click',function(){document.getElementById('tl-modal').classList.add('open');});
document.getElementById('tl-close').addEventListener('click',function(){document.getElementById('tl-modal').classList.remove('open');});
document.getElementById('tl-modal').addEventListener('click',function(e){if(e.target===this)this.classList.remove('open');});

// Import
document.getElementById('import-toggle').addEventListener('click',function(){document.getElementById('import-panel').classList.toggle('open');document.getElementById('comp-panel').classList.remove('open');});
document.querySelectorAll('.imp-tab').forEach(function(tab){
  tab.addEventListener('click',function(){
    document.querySelectorAll('.imp-tab').forEach(function(t){t.classList.remove('active');});
    document.querySelectorAll('.imp-content').forEach(function(c){c.classList.remove('active');});
    tab.classList.add('active'); document.getElementById('tab-'+tab.dataset.tab).classList.add('active');
  });
});
function parseRow(cells){
  if(!cells[1]||!cells[1].trim()) return null;
  var dr=cells[0]?cells[0].trim():''; var dv='';
  if(dr){var d=new Date(dr);if(!isNaN(d))dv=d.toISOString().split('T')[0];}
  var pr=cells[5]?String(cells[5]).replace(/[$,\s]/g,''):'';
  return{date:dv,address:cells[1].trim(),name:cells[2]?cells[2].trim():'',type:cells[3]?cells[3].trim():'',units:parseInt(cells[4])||0,price:parseFloat(pr)||null,foia:cells[7]?cells[7].trim():'',buyer:cells[8]?cells[8].trim():'',owner:cells[9]?cells[9].trim():''};
}
function importRows(rows){var n=0;rows.forEach(function(r){var p=parseRow(r);if(p){p._idx=allData.length;importedData.push(p);allData.push(p);n++;}});return n;}
function showMsg(t,tp){var e=document.getElementById('imp-msg');e.textContent=t;e.className='imp-msg '+tp;clearTimeout(window._mt);window._mt=setTimeout(function(){e.className='imp-msg';},4500);}
function isHdr(cells){var f=(cells[0]||'').toLowerCase();return f.includes('date')||f.includes('topa');}
document.getElementById('btn-paste-imp').addEventListener('click',function(){
  var t=document.getElementById('paste-input').value.trim();
  if(!t){showMsg('Paste some data first.','err');return;}
  var rows=t.split('\n').map(function(l){return l.split('\t');});
  var s=isHdr(rows[0])?1:0; var n=importRows(rows.slice(s));
  if(n>0){showMsg('‚úì Added '+n+' propert'+(n===1?'y':'ies')+'.','ok');document.getElementById('paste-input').value='';applyFilters();}
  else showMsg('No valid rows found ‚Äî check column order.','err');
});
var csvInput=document.getElementById('csv-input'); var fileDrop=document.getElementById('file-drop');
fileDrop.addEventListener('click',function(){csvInput.click();});
fileDrop.addEventListener('dragover',function(e){e.preventDefault();fileDrop.classList.add('dov');});
fileDrop.addEventListener('dragleave',function(){fileDrop.classList.remove('dov');});
fileDrop.addEventListener('drop',function(e){
  e.preventDefault();fileDrop.classList.remove('dov');
  if(e.dataTransfer.files[0]){try{var dt=new DataTransfer();dt.items.add(e.dataTransfer.files[0]);csvInput.files=dt.files;}catch(err){}
  document.getElementById('drop-lbl').textContent=e.dataTransfer.files[0].name;}
});
csvInput.addEventListener('change',function(){if(csvInput.files[0])document.getElementById('drop-lbl').textContent=csvInput.files[0].name;});
document.getElementById('btn-csv-imp').addEventListener('click',function(){
  var file=csvInput.files[0]; if(!file){showMsg('Select a CSV file first.','err');return;}
  var reader=new FileReader();
  reader.onload=function(e){
    var rows=e.target.result.split('\n').map(function(line){
      var res=[],cur='',inQ=false;
      for(var i=0;i<line.length;i++){var ch=line[i];if(ch==='"'){inQ=!inQ;}else if(ch===','&&!inQ){res.push(cur.trim());cur='';}else cur+=ch;}
      res.push(cur.trim());return res;
    }).filter(function(r){return r.some(function(c){return c;});});
    var s=isHdr(rows[0])?1:0; var n=importRows(rows.slice(s));
    if(n>0){showMsg('‚úì Added '+n+' from CSV.','ok');document.getElementById('drop-lbl').textContent='Drop CSV here or click to browse';applyFilters();}
    else showMsg('No valid rows found.','err');
  };
  reader.readAsText(file);
});
document.getElementById('btn-clr-all').addEventListener('click',function(){
  if(!importedData.length){showMsg('No imported data to clear.','err');return;}
  importedData=[];allData=BASE_DATA.map(function(p){return Object.assign({},p);});
  showMsg('Imported data cleared.','ok');applyFilters();
});

// ‚îÄ‚îÄ COMPS DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var compsData = []; // all loaded comps: {id, address, name, price, date, units, sf, ppu, ppsf, yearBuilt, class, capRate, pfCapRate, buyer, seller, broker, affType, notes, topaId:null|idx}
var compMarkers = [];
var matchQueue = []; // pending matching sessions
var matchQueueIdx = 0;
var matchSelectedCandidate = null;

// Remote loading handled in DOMContentLoaded

function compsDupe(c){
  return compsData.some(function(x){ return x.address===c.address && x.date===c.date; });
}

function parseCompRow(cells){
  // Columns: Name ¬∑ Address ¬∑ Sale Price ¬∑ Sale Date ¬∑ Units ¬∑ Price/Unit ¬∑ Building SF ¬∑ Price/SF ¬∑ Affordable Type ¬∑ Vacancy ¬∑ Year Built ¬∑ PF Cap Rate ¬∑ Actual Cap Rate ¬∑ Building Class ¬∑ Buyer ¬∑ Seller ¬∑ Listing Broker ¬∑ Transaction Notes ¬∑ Age
  var addr = (cells[1]||'').trim(); if(!addr) return null;
  var pr = parseFloat(String(cells[2]||'').replace(/[$,\s]/g,''))||null;
  var rawDate = (cells[3]||'').trim(); var dv='';
  if(rawDate){ var dd=new Date(rawDate); if(!isNaN(dd)) dv=dd.toISOString().split('T')[0]; }
  return {
    id: Date.now()+Math.random(),
    name: (cells[0]||'').trim(),
    address: addr,
    price: pr,
    date: dv,
    units: parseInt(cells[4])||null,
    ppu: parseFloat(String(cells[5]||'').replace(/[$,\s]/g,''))||null,
    sf: parseFloat(String(cells[6]||'').replace(/[,\s]/g,''))||null,
    ppsf: parseFloat(String(cells[7]||'').replace(/[$,\s]/g,''))||null,
    affType: (cells[8]||'').trim(),
    vacancy: (cells[9]||'').trim(),
    yearBuilt: parseInt(cells[10])||null,
    pfCapRate: parseFloat(cells[11])||null,
    capRate: parseFloat(cells[12])||null,
    bldgClass: (cells[13]||'').trim(),
    buyer: (cells[14]||'').trim(),
    seller: (cells[15]||'').trim(),
    broker: (cells[16]||'').trim(),
    notes: (cells[17]||'').trim(),
    topaId: null
  };
}

function isCompHdr(cells){ var f=(cells[0]||'').toLowerCase(); return f.includes('name')||f.includes('property'); }

function importComps(rows){
  var added=0;
  rows.forEach(function(r){
    var c=parseCompRow(r);
    if(c && !compsDupe(c)){ compsData.push(c); added++; }
  });
  return added;
}

function showCompMsg(t,tp){
  var e=document.getElementById('comp-imp-msg');
  e.textContent=t; e.className='comp-imp-msg '+tp;
  clearTimeout(window._cmt); window._cmt=setTimeout(function(){e.className='comp-imp-msg';},5000);
}

// ‚îÄ‚îÄ FUZZY MATCHING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function normalizeAddr(s){
  return (s||'').toLowerCase()
    .replace(/\./g,'').replace(/,/g,' ')
    .replace(/[-‚Äì‚Äî]/g,' ')
    // Expand full words to canonical short form FIRST (so both sides become identical)
    .replace(/\bstreet\b/g,'st')
    .replace(/\bavenue\b/g,'ave')
    .replace(/\bboulevard\b/g,'blvd')
    .replace(/\bplace\b/g,'pl')
    .replace(/\broad\b/g,'rd')
    .replace(/\bdrive\b/g,'dr')
    .replace(/\bcourt\b/g,'ct')
    .replace(/\blane\b/g,'ln')
    .replace(/\bterrace\b/g,'ter')
    .replace(/\bcircle\b/g,'cir')
    .replace(/\bsquare\b/g,'sq')
    .replace(/\bway\b/g,'wy')
    .replace(/\bhighway\b/g,'hwy')
    .replace(/\bparkway\b/g,'pkwy')
    .replace(/\bnorthwest\b/g,'nw')
    .replace(/\bnortheast\b/g,'ne')
    .replace(/\bsouthwest\b/g,'sw')
    .replace(/\bsoutheast\b/g,'se')
    .replace(/\bnorth\b/g,'n')
    .replace(/\bsouth\b/g,'s')
    .replace(/\beast\b/g,'e')
    .replace(/\bwest\b/g,'w')
    .replace(/\s+/g,' ').trim();
}

function addrSimilarity(a, b){
  var na = normalizeAddr(a), nb = normalizeAddr(b);
  if(na === nb) return 1.0;
  // Extract first number token
  var numA = (na.match(/^\d+/) || [''])[0];
  var numB = (nb.match(/^\d+/) || [''])[0];
  if(numA && numB && numA !== numB) return 0; // different street numbers = not a match
  // Jaccard on word tokens
  var wa = new Set(na.split(' ').filter(Boolean));
  var wb = new Set(nb.split(' ').filter(Boolean));
  var inter = 0; wa.forEach(function(w){ if(wb.has(w)) inter++; });
  var union = new Set([...wa,...wb]).size;
  return union ? inter/union : 0;
}

function findCandidates(compAddr){
  var results = [];
  allData.forEach(function(p, idx){
    var score = addrSimilarity(compAddr, p.address);
    if(score > 0.3) results.push({idx:idx, prop:p, score:score});
  });
  results.sort(function(a,b){ return b.score - a.score; });
  return results.slice(0,4);
}

// Auto-match comps where score is >= 0.85 (essentially same address, different abbreviation)
function autoMatchHighConfidence(){
  var autoMatched = 0;
  compsData.forEach(function(c){
    if(c.topaId !== null && c.topaId !== undefined) return;
    var candidates = findCandidates(c.address);
    if(candidates.length && candidates[0].score >= 0.85){
      c.topaId = candidates[0].idx;
      autoMatched++;
    }
  });
  return autoMatched;
}

// ‚îÄ‚îÄ MATCH QUEUE SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function runMatching(){
  var autoMatched = autoMatchHighConfidence();
  // Only queue comps that are unmatched AND have at least one candidate ‚Äî skip ones with zero options
  matchQueue = compsData.filter(function(c){
    if(c.topaId !== null && c.topaId !== undefined) return false;
    return findCandidates(c.address).length > 0;
  });
  var skipped = compsData.filter(function(c){
    return (c.topaId === null || c.topaId === undefined) && findCandidates(c.address).length === 0;
  }).length;
  matchQueueIdx = 0;
  if(!matchQueue.length){
    var parts = [];
    if(autoMatched) parts.push('Auto-matched '+autoMatched+' comp'+(autoMatched===1?'':'s')+' by address.');
    if(skipped) parts.push(skipped+' comp'+(skipped===1?' has':'s have')+' no potential TOPA match and were skipped.');
    if(!parts.length) parts.push('All comps are already matched or there are no comps loaded.');
    alert(parts.join(' '));
    refreshAfterCompChange();
    return;
  }
  var noticeParts = [];
  if(autoMatched) noticeParts.push('Auto-matched '+autoMatched+'.');
  if(skipped) noticeParts.push(skipped+' skipped (no candidates).');
  noticeParts.push(matchQueue.length+' need review.');
  var notice = noticeParts.join(' ');
  document.getElementById('match-modal').classList.add('open');
  document.getElementById('match-progress-lbl').textContent = notice;
  setTimeout(showMatchStep, 800);
}

function showMatchStep(){
  var total = matchQueue.length;
  var progressLbl = document.getElementById('match-progress-lbl');
  var body = document.getElementById('match-body');
  var btnAccept = document.getElementById('match-btn-accept');
  var btnSkip = document.getElementById('match-btn-skip');
  var btnDone = document.getElementById('match-btn-done');

  if(matchQueueIdx >= total){
    progressLbl.textContent = 'Matching complete!';
    body.innerHTML = '<div style="text-align:center;padding:24px 0;"><div style="font-size:2rem;margin-bottom:8px;">‚úÖ</div><div style="font-size:0.9rem;font-weight:700;color:var(--navy);">All comps reviewed.</div><div style="font-size:0.73rem;color:var(--muted);margin-top:6px;">Matched comps will appear in their TOPA property popup and sidebar. Unmatched comps appear on the map in purple.</div></div>';
    btnAccept.style.display='none'; btnSkip.style.display='none'; btnDone.style.display='block';
    refreshAfterCompChange(); return;
  }

  matchSelectedCandidate = null;
  var comp = matchQueue[matchQueueIdx];
  var candidates = findCandidates(comp.address);
  progressLbl.textContent = 'Comp '+(matchQueueIdx+1)+' of '+total+' ‚Äî review and approve or skip';
  btnAccept.style.display='block'; btnSkip.style.display='block'; btnDone.style.display='none';

  var compMeta = [
    comp.price ? fmt$(comp.price) : null,
    comp.date ? fmtDate(comp.date) : null,
    comp.units ? comp.units+' units' : null,
    comp.sf ? comp.sf.toLocaleString()+' SF' : null
  ].filter(Boolean).join(' ¬∑ ');

  var candidateHtml = candidates.length
    ? candidates.map(function(c, ci){
        var scoreClass = c.score > 0.7 ? 'mc-score-hi' : 'mc-score-med';
        var pct = Math.round(c.score*100);
        return '<div class="match-candidate" data-ci="'+ci+'" onclick="selectCandidate('+ci+',this)">'+
          '<div class="mc-radio"></div>'+
          '<div class="mc-info" style="flex:1;">'+
            '<h5>'+c.prop.address+'</h5>'+
            '<p>'+(c.prop.name||'No deal name')+' ¬∑ '+c.prop.units+' units ¬∑ '+fmt$(c.prop.price)+'</p>'+
          '</div>'+
          '<span class="mc-score '+scoreClass+'">'+pct+'% match</span>'+
        '</div>';
      }).join('')
    : '<div class="match-no-candidates">No similar TOPA addresses found. This comp will remain unmatched on the map.</div>';

  body.innerHTML =
    '<div class="match-comp-card">'+
      '<h4>'+(comp.name||comp.address)+'</h4>'+
      '<div style="font-size:0.7rem;color:var(--navy);margin-bottom:4px;">'+comp.address+'</div>'+
      '<div class="mc-meta"><span>'+compMeta+'</span>'+(comp.buyer?'<span>Buyer: '+comp.buyer+'</span>':'')+(comp.seller?'<span>Seller: '+comp.seller+'</span>':'')+'</div>'+
    '</div>'+
    '<div class="match-section-lbl">Possible TOPA Matches ‚Äî select one, then click Accept</div>'+
    candidateHtml;

  window._matchCandidates = candidates;
}

window.selectCandidate = function(ci, el){
  document.querySelectorAll('.match-candidate').forEach(function(x){ x.classList.remove('selected'); });
  el.classList.add('selected'); matchSelectedCandidate = ci;
};

document.getElementById('match-btn-accept').addEventListener('click', function(){
  var comp = matchQueue[matchQueueIdx];
  if(matchSelectedCandidate !== null && window._matchCandidates && window._matchCandidates[matchSelectedCandidate]){
    comp.topaId = window._matchCandidates[matchSelectedCandidate].idx;
  }
  matchQueueIdx++; showMatchStep();
});
document.getElementById('match-btn-skip').addEventListener('click', function(){
  matchQueueIdx++; showMatchStep();
});
document.getElementById('match-btn-done').addEventListener('click', function(){
  document.getElementById('match-modal').classList.remove('open');
});
document.getElementById('match-close').addEventListener('click', function(){
  document.getElementById('match-modal').classList.remove('open');
});
document.getElementById('match-modal').addEventListener('click', function(e){ if(e.target===this) this.classList.remove('open'); });

// ‚îÄ‚îÄ COMP MARKERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderCompMarkers(){
  compMarkers.forEach(function(m){ map.removeLayer(m); });
  compMarkers = [];
  // In archive view, or when search is active, comp markers are not shown
  if(showingArchive) return;
  var searchTerm = (document.getElementById('prop-search').value||'').toLowerCase().trim();
  if(searchTerm) return; // search is TOPA-focused; hide unmatched comp dots
  var toShow = compsData.filter(function(c){ return c.topaId === null || c.topaId === undefined; });
  for(var i=0; i<toShow.length; i++){
    var c = toShow[i];
    var coords = await geocode(c.address);
    if(!coords) continue;
    var icon = L.divIcon({
      className:'',
      html:'<div style="width:14px;height:14px;border-radius:50%;background:#7c3aed;border:2.5px solid white;box-shadow:0 1px 4px rgba(0,0,0,0.35);cursor:pointer;"></div>',
      iconSize:[14,14], iconAnchor:[7,7], popupAnchor:[0,-8]
    });
    var html = buildCompPopupHtml(c);
    var mk = L.marker(coords, {icon:icon}).bindPopup(html, {maxWidth:290});
    mk.addTo(map);
    compMarkers.push(mk);
  }
}

function buildCompPopupHtml(c){
  var ppu = (c.price && c.units) ? Math.round(c.price/c.units) : (c.ppu || null);
  var ppsf = c.ppsf || (c.price && c.sf ? Math.round(c.price/c.sf*100)/100 : null);
  return '<div style="font-size:0.7rem;font-weight:700;color:#c4b5fd;margin-bottom:2px;">SALE COMP</div>'+
    '<div class="pu-addr">'+(c.name||c.address)+'</div>'+
    (c.name ? '<div class="pu-name">'+c.address+'</div>' : '')+
    '<div class="pu-grid">'+
    (c.date ? '<div class="pu-f"><label>Sale Date</label><span>'+fmtDate(c.date)+'</span></div>' : '')+
    (c.units ? '<div class="pu-f"><label>Units</label><span>'+c.units+'</span></div>' : '')+
    (c.price ? '<div class="pu-f"><label>Sale Price</label><span>'+fmtFull$(c.price)+'</span></div>' : '')+
    (ppu ? '<div class="pu-f"><label>Price / Unit</label><span>$'+ppu.toLocaleString()+'</span></div>' : '')+
    (c.sf ? '<div class="pu-f"><label>Building SF</label><span>'+c.sf.toLocaleString()+'</span></div>' : '')+
    (ppsf ? '<div class="pu-f"><label>Price / SF</label><span>$'+ppsf+'</span></div>' : '')+
    (c.yearBuilt ? '<div class="pu-f"><label>Year Built</label><span>'+c.yearBuilt+'</span></div>' : '')+
    (c.capRate ? '<div class="pu-f"><label>Cap Rate</label><span>'+c.capRate+'%</span></div>' : '')+
    (c.buyer ? '<div class="pu-f wide"><label>Buyer</label><span>'+c.buyer+'</span></div>' : '')+
    (c.seller ? '<div class="pu-f wide"><label>Seller</label><span>'+c.seller+'</span></div>' : '')+
    '</div>'+
    (c.notes ? '<div style="font-size:0.62rem;color:rgba(255,255,255,0.5);margin-top:6px;padding-top:6px;border-top:1px solid rgba(255,255,255,0.1);font-style:italic;">'+c.notes+'</div>' : '')+
    '<div style="margin-top:8px;padding:4px 7px;background:rgba(124,58,237,0.25);border-radius:4px;font-size:0.6rem;color:#c4b5fd;font-weight:600;">No TOPA match ‚Äî standalone comp</div>';
}

// ‚îÄ‚îÄ COMP SIDEBAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCompsSidebar(){
  var el = document.getElementById('comps-sidebar-list');
  var badge = document.getElementById('comp-cnt-badge');
  var wrap = document.getElementById('comp-panel-list-wrap');
  badge.textContent = compsData.length;
  if(!compsData.length){
    wrap.style.display = 'none';
    el.innerHTML = '';
    return;
  }
  wrap.style.display = 'block';
  el.innerHTML = compsData.map(function(c, ci){
    var ppu = (c.price && c.units) ? Math.round(c.price/c.units) : c.ppu;
    var matched = (c.topaId !== null && c.topaId !== undefined);
    return '<div class="comp-list-item" onclick="focusComp('+ci+')">'+
      '<div class="cli-addr">'+(c.name||c.address)+'</div>'+
      '<div class="cli-meta">'+
        (c.date ? '<span>'+fmtDate(c.date)+'</span>' : '')+
        (c.price ? '<span><strong>'+fmt$(c.price)+'</strong></span>' : '')+
        (ppu ? '<span>'+fmt$(ppu)+'/unit</span>' : '')+
      '</div>'+
      '<div class="'+(matched?'cli-match':'cli-unmatched')+'">'+(matched?'‚úì Matched':' Unmatched')+
        (matched&&allData[c.topaId] ? ' ¬∑ '+allData[c.topaId].address.substring(0,28) : '')+
      '</div>'+
    '</div>';
  }).join('');
}

window.focusComp = async function(ci){
  var c = compsData[ci];
  var coords = await geocode(c.address);
  if(coords) map.flyTo(coords, 16, {animate:true, duration:0.8});
  openCompDetail(ci);
};

// Ensure the mixed list re-renders when comp data changes
function refreshAfterCompChange(){
  renderCompsSidebar();
  renderList();
  applyFilters();
}

// ‚îÄ‚îÄ COMP POPUP TABS in TOPA popup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getCompsForTopa(topaPropIdx){
  return compsData.filter(function(c){ return c.topaId === topaPropIdx; });
}

function buildCompsTabHtml(topaPropIdx){
  var cs = getCompsForTopa(topaPropIdx);
  if(!cs.length) return '<div class="no-comps-msg">No sale comps linked to this property. Import comps and run address matching.</div>';
  return cs.map(function(c){
    var ppu = (c.price && c.units) ? Math.round(c.price/c.units) : c.ppu;
    var ppsf = c.ppsf || (c.price && c.sf ? Math.round(c.price/c.sf*100)/100 : null);
    return '<div class="pu-comp-card">'+
      '<div class="pu-comp-addr">'+(c.name ? c.name+' ‚Äî ' : '')+c.address+'</div>'+
      '<div class="pu-comp-grid">'+
      (c.date ? '<div class="pu-comp-f"><label>Sale Date</label><span>'+fmtDate(c.date)+'</span></div>' : '')+
      (c.price ? '<div class="pu-comp-f"><label>Sale Price</label><span>'+fmtFull$(c.price)+'</span></div>' : '')+
      (c.units ? '<div class="pu-comp-f"><label>Units</label><span>'+c.units+'</span></div>' : '')+
      (ppu ? '<div class="pu-comp-f"><label>Price / Unit</label><span>$'+ppu.toLocaleString()+'</span></div>' : '')+
      (c.sf ? '<div class="pu-comp-f"><label>Bldg SF</label><span>'+c.sf.toLocaleString()+'</span></div>' : '')+
      (ppsf ? '<div class="pu-comp-f"><label>Price / SF</label><span>$'+ppsf+'</span></div>' : '')+
      (c.yearBuilt ? '<div class="pu-comp-f"><label>Year Built</label><span>'+c.yearBuilt+'</span></div>' : '')+
      (c.capRate ? '<div class="pu-comp-f"><label>Cap Rate</label><span>'+c.capRate+'%</span></div>' : '')+
      (c.pfCapRate ? '<div class="pu-comp-f"><label>PF Cap Rate</label><span>'+c.pfCapRate+'%</span></div>' : '')+
      (c.buyer ? '<div class="pu-comp-f wide"><label>Buyer</label><span>'+c.buyer+'</span></div>' : '')+
      (c.seller ? '<div class="pu-comp-f wide"><label>Seller</label><span>'+c.seller+'</span></div>' : '')+
      (c.broker ? '<div class="pu-comp-f wide"><label>Listing Broker</label><span>'+c.broker+'</span></div>' : '')+
      '</div>'+
      (c.notes ? '<div class="pu-comp-notes">'+c.notes+'</div>' : '')+
    '</div>';
  }).join('');
}

// ‚îÄ‚îÄ COMP SIDEBAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.openCompSidebar = function(topaPropIdx){
  var cs = getCompsForTopa(topaPropIdx);
  if(!cs.length) return;
  var prop = allData.find(function(p){ return p._idx === topaPropIdx; });
  var label = (prop && (prop.name || prop.address)) ? (prop.name || prop.address) : 'Sale Comps';
  document.getElementById('comp-sidebar-addr').textContent = label;

  var html = cs.map(function(c){
    var ppu = (c.price && c.units) ? Math.round(c.price/c.units) : c.ppu;
    var ppsf = c.ppsf || (c.price && c.sf ? Math.round(c.price/c.sf*100)/100 : null);
    return '<div class="comp-sidebar-card">'+
      '<div class="comp-sidebar-card-name">'+(c.name ? c.name+' ‚Äî ' : '')+c.address+'</div>'+
      '<div class="comp-sidebar-grid">'+
      (c.date    ? '<div class="comp-sidebar-f"><label>Sale Date</label><span>'+fmtDate(c.date)+'</span></div>' : '')+
      (c.price   ? '<div class="comp-sidebar-f"><label>Sale Price</label><span>'+fmtFull$(c.price)+'</span></div>' : '')+
      (c.units   ? '<div class="comp-sidebar-f"><label>Units</label><span>'+c.units+'</span></div>' : '')+
      (ppu       ? '<div class="comp-sidebar-f"><label>Price / Unit</label><span>$'+ppu.toLocaleString()+'</span></div>' : '')+
      (c.sf      ? '<div class="comp-sidebar-f"><label>Bldg SF</label><span>'+c.sf.toLocaleString()+'</span></div>' : '')+
      (ppsf      ? '<div class="comp-sidebar-f"><label>Price / SF</label><span>$'+ppsf+'</span></div>' : '')+
      (c.yearBuilt ? '<div class="comp-sidebar-f"><label>Year Built</label><span>'+c.yearBuilt+'</span></div>' : '')+
      (c.capRate ? '<div class="comp-sidebar-f"><label>Cap Rate</label><span>'+c.capRate+'%</span></div>' : '')+
      (c.pfCapRate ? '<div class="comp-sidebar-f"><label>PF Cap Rate</label><span>'+c.pfCapRate+'%</span></div>' : '')+
      (c.buyer   ? '<div class="comp-sidebar-f wide"><label>Buyer</label><span>'+c.buyer+'</span></div>' : '')+
      (c.seller  ? '<div class="comp-sidebar-f wide"><label>Seller</label><span>'+c.seller+'</span></div>' : '')+
      (c.broker  ? '<div class="comp-sidebar-f wide"><label>Listing Broker</label><span>'+c.broker+'</span></div>' : '')+
      '</div>'+
      (c.notes ? '<div class="comp-sidebar-notes">'+c.notes+'</div>' : '')+
    '</div>';
  }).join('');

  document.getElementById('comp-sidebar-body').innerHTML = html;
  document.getElementById('comp-sidebar-panel').classList.add('open');
};

document.getElementById('comp-sidebar-close').addEventListener('click', function(){
  document.getElementById('comp-sidebar-panel').classList.remove('open');
});

// Patch renderMarkers: three color states + collapsible accordion popup
var _origRenderMarkers = renderMarkers;
renderMarkers = async function(){
  var gen = ++_markerGen; // snapshot this render's generation
  markers.forEach(function(m){map.removeLayer(m);});
  markers=[];
  for(var i=0;i<filteredData.length;i++){
    if(gen !== _markerGen){ console.warn('[TOPA] renderMarkers aborted at index', i, 'of', filteredData.length, '‚Äî gen', gen, 'vs', _markerGen); return; } // a newer render started ‚Äî abort this one
    var p=filteredData[i];
    var topaOrigIdx = p._idx;
    var coords=await geocode(p.address);
    if(gen !== _markerGen) return; // abort if superseded while geocoding
    if(!coords){ console.warn('[TOPA] No coords for:', p.address); continue; }
    var arc=isArc(p); var isC=p.type==='w/ Contract';
    var hasComps = getCompsForTopa(topaOrigIdx).length > 0;
    // Color: gray if archived with no comp, gold if has comp (active or archived), emerald if active with no comp
    var color = hasComps ? '#d97706' : (arc ? '#94a3b8' : '#059669');
    var days=daysIn(p.date); var ppuVal=getPPU(p);
    var compsList = getCompsForTopa(topaOrigIdx);
    var sold = hasComps && compsList[0] && compsList[0].date;
    var soldDate = sold ? compsList[0].date : null;
    var daysAtSale = sold ? Math.max(0, Math.round((new Date(soldDate) - new Date(p.date)) / 86400000)) : days;
    var segsThresh=[5,50,185,305,420];
    var segColors=['#16a34a','#22c55e','#d97706','#ea580c','#dc2626'];
    var popSegHtml;
    if(sold){
      popSegHtml = segsThresh.map(function(){ return '<div style="flex:1;height:4px;border-radius:1px;background:#d97706"></div>'; }).join('');
    } else {
      popSegHtml = segsThresh.map(function(t,si){
        var filled=days>=t;
        return '<div style="flex:1;height:4px;border-radius:1px;background:'+(filled?segColors[si]:'rgba(255,255,255,0.15)')+'"></div>';
      }).join('');
    }
    var ms=getMilestonePhase(days);
    

    // Build comps column HTML if property has matched comps
    var compsColHtml = '';
    if(hasComps){
      var cs = getCompsForTopa(topaOrigIdx);
      var compCards = cs.map(function(c){
        var cppu = (c.price && c.units) ? Math.round(c.price/c.units) : c.ppu;
        var cppsf = c.ppsf || (c.price && c.sf ? Math.round(c.price/c.sf*100)/100 : null);
        return '<div class="pop-comp-card">'+
          '<div class="pop-comp-name">'+(c.name||c.address)+'</div>'+
          (c.name && c.address !== c.name ? '<div class="pop-comp-sub">'+c.address+'</div>' : '')+
          '<div class="pop-comp-grid">'+
          (c.date    ? '<div class="pop-comp-f"><label>Sale Date</label><span>'+fmtDate(c.date)+'</span></div>' : '')+
          (c.price   ? '<div class="pop-comp-f"><label>Price</label><span>'+fmtFull$(c.price)+'</span></div>' : '')+
          (c.units   ? '<div class="pop-comp-f"><label>Units</label><span>'+c.units+'</span></div>' : '')+
          (cppu      ? '<div class="pop-comp-f"><label>$/Unit</label><span>$'+cppu.toLocaleString()+'</span></div>' : '')+
          (c.sf      ? '<div class="pop-comp-f"><label>SF</label><span>'+c.sf.toLocaleString()+'</span></div>' : '')+
          (cppsf     ? '<div class="pop-comp-f"><label>$/SF</label><span>$'+cppsf+'</span></div>' : '')+
          (c.capRate ? '<div class="pop-comp-f"><label>Cap Rate</label><span>'+c.capRate+'%</span></div>' : '')+
          (c.buyer   ? '<div class="pop-comp-f pop-comp-wide"><label>Buyer</label><span>'+c.buyer+'</span></div>' : '')+
          (c.seller  ? '<div class="pop-comp-f pop-comp-wide"><label>Seller</label><span>'+c.seller+'</span></div>' : '')+
          '</div>'+
          (c.notes ? '<div class="pop-comp-notes">'+c.notes+'</div>' : '')+
        '</div>';
      }).join('');
      compsColHtml = '<div class="pop-comp-col">'+
        '<div class="pop-comp-col-hdr">üè∑ Sale Comps <span class="pop-comp-count">'+cs.length+'</span></div>'+
        '<div class="pop-comp-col-body">'+compCards+'</div>'+
      '</div>';
    }

    var topaContent = '<div class="pu-addr">'+p.address+'</div>'+
      (p.name?'<div class="pu-name">'+p.name+'</div>':'')+
      '<div class="pu-grid">'+
      '<div class="pu-f"><label>TOPA Date</label><span>'+fmtDate(p.date)+'</span></div>'+
      '<div class="pu-f"><label>Units</label><span>'+p.units+'</span></div>'+
      '<div class="pu-f"><label>Price</label><span>'+fmtFull$(p.price)+'</span></div>'+
      '<div class="pu-f"><label>Price / Unit</label><span>'+(ppuVal?'$'+ppuVal.toLocaleString():'‚Äî')+'</span></div>'+
      (p.buyer?'<div class="pu-f wide"><label>Buyer</label><span>'+p.buyer+'</span></div>':'')+
      (p.owner?'<div class="pu-f wide"><label>Owner / Seller</label><span>'+p.owner+'</span></div>':'')+
      '<div class="pu-f"><label>FOIA</label><span>'+(p.foia||'‚Äî')+'</span></div>'+
      '</div>'+
      '<div class="pu-tags"><span class="pu-tag '+(arc?'arc':(isC?'c':'nc'))+'">'+p.type+'</span></div>'+
      '<div class="pu-topa-bar">'+
      '<div class="pu-topa-lbl">TOPA Progress ¬∑ <strong style="color:white">'+(sold?'Sold':ms.label)+'</strong></div>'+
      '<div style="display:flex;gap:2px;margin:5px 0 4px">'+popSegHtml+'</div>'+
      '<div style="display:flex;justify-content:space-between;font-size:0.6rem;color:rgba(255,255,255,0.38)">'+
      '<span>Day 0</span><span>45</span><span>185</span><span>305</span><span>420</span>'+
      '</div>'+
      '<div class="pu-topa-info" style="margin-top:5px"><strong>'+(sold?daysAtSale:days)+' days</strong><span>'+(sold?'Sold ¬∑ '+fmtDate(soldDate):(arc?'Archived':Math.max(0,TOPA_LIMIT-days)+' days left'))+'</span></div>'+
      '</div>'+
      '<div class="pu-milestones" style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.1)">'+
      '<div style="font-size:0.55rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.38);margin-bottom:5px">'+(sold?'Outcome':'Current Phase')+'</div>'+
      '<div style="font-size:0.75rem;font-weight:700;color:white">'+(sold?'‚úì Sold ‚Äî Process Complete':ms.label)+'</div>'+
      '</div>';

    var html = hasComps
      ? '<div class="pop-outer">'+'<div class="pop-topa-col">'+topaContent+'</div>'+compsColHtml+'</div>'
      : topaContent;

    (function(idx){
      var opacity=arc?'0.5':'1';
      var icon=L.divIcon({
        className:'',
        html:'<div style="width:16px;height:16px;border-radius:50%;background:'+color+';border:2.5px solid white;box-shadow:0 1px 4px rgba(0,0,0,0.35);opacity:'+opacity+';cursor:pointer;"></div>',
        iconSize:[16,16],iconAnchor:[8,8],popupAnchor:[0,-10]
      });
      var mk=L.marker(coords,{icon:icon}).bindPopup(html,{maxWidth:hasComps?620:320,className:hasComps?'pop-wide-popup':''});
      mk.on('click',function(){hlItem(idx);});
      mk.addTo(map);
      markers.push(mk);
      p._marker = mk; // bind to property for focusProp lookup
    })(i);
  }
  renderCompMarkers();
};

// ‚îÄ‚îÄ FLOATING COMP DETAIL PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openCompDetail(ci){
  var c = compsData[ci];
  if(!c) return;
  var ppu = (c.price && c.units) ? Math.round(c.price/c.units) : c.ppu;
  var ppsf = c.ppsf || (c.price && c.sf ? Math.round(c.price/c.sf*100)/100 : null);
  document.getElementById('cdp-title').textContent = c.name || c.address;
  document.getElementById('cdp-sub').textContent = c.name ? c.address : (c.date ? fmtDate(c.date) : '');
  var linkedTopa = (c.topaId !== null && c.topaId !== undefined && allData[c.topaId])
    ? '<div class="cd-topa-link">‚úì Linked to TOPA: '+allData[c.topaId].address+'</div>' : '';
  document.getElementById('cdp-body').innerHTML =
    '<div class="cdg">'+
    (c.date ? '<div class="cdg-f"><label>Sale Date</label><span>'+fmtDate(c.date)+'</span></div>' : '')+
    (c.price ? '<div class="cdg-f"><label>Sale Price</label><span>'+fmtFull$(c.price)+'</span></div>' : '')+
    (c.units ? '<div class="cdg-f"><label>Units</label><span>'+c.units+'</span></div>' : '')+
    (ppu ? '<div class="cdg-f"><label>Price / Unit</label><span>$'+ppu.toLocaleString()+'</span></div>' : '')+
    (c.sf ? '<div class="cdg-f"><label>Building SF</label><span>'+c.sf.toLocaleString()+'</span></div>' : '')+
    (ppsf ? '<div class="cdg-f"><label>Price / SF</label><span>$'+ppsf+'</span></div>' : '')+
    (c.yearBuilt ? '<div class="cdg-f"><label>Year Built</label><span>'+c.yearBuilt+'</span></div>' : '')+
    (c.bldgClass ? '<div class="cdg-f"><label>Class</label><span>'+c.bldgClass+'</span></div>' : '')+
    (c.capRate ? '<div class="cdg-f"><label>Actual Cap Rate</label><span>'+c.capRate+'%</span></div>' : '')+
    (c.pfCapRate ? '<div class="cdg-f"><label>PF Cap Rate</label><span>'+c.pfCapRate+'%</span></div>' : '')+
    (c.affType ? '<div class="cdg-f wide"><label>Affordable Type</label><span>'+c.affType+'</span></div>' : '')+
    '</div>'+
    ((c.buyer||c.seller||c.broker) ? '<div class="cd-section-lbl">Parties</div><div class="cdg">'+
    (c.buyer ? '<div class="cdg-f wide"><label>Buyer</label><span>'+c.buyer+'</span></div>' : '')+
    (c.seller ? '<div class="cdg-f wide"><label>Seller</label><span>'+c.seller+'</span></div>' : '')+
    (c.broker ? '<div class="cdg-f wide"><label>Listing Broker</label><span>'+c.broker+'</span></div>' : '')+
    '</div>' : '')+
    (c.notes ? '<div class="cd-section-lbl">Notes</div><div class="cd-notes">'+c.notes+'</div>' : '')+
    linkedTopa;
  document.getElementById('comp-detail-panel').classList.add('open');
}

document.getElementById('comp-detail-close').addEventListener('click', function(){
  document.getElementById('comp-detail-panel').classList.remove('open');
});

// ‚îÄ‚îÄ JSON EXPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('btn-export-comps').addEventListener('click', function(){
  if(!compsData.length){ alert('No comps to export.'); return; }
  var json = JSON.stringify(compsData, null, 2);
  var blob = new Blob([json], {type:'application/json'});
  var a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'sales_comps.json'; a.click(); URL.revokeObjectURL(a.href);
});

document.getElementById('btn-export-props').addEventListener('click', function(){
  if(!allData.length){ alert('No properties to export.'); return; }
  // Strip internal _idx before exporting ‚Äî it gets re-assigned on load
  var clean = allData.map(function(p){ var o=Object.assign({},p); delete o._idx; delete o._marker; return o; });
  var json = JSON.stringify(clean, null, 2);
  var blob = new Blob([json], {type:'application/json'});
  var a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'properties.json'; a.click(); URL.revokeObjectURL(a.href);
});

// ‚îÄ‚îÄ COMPS IMPORT EVENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Comp panel toggle
document.getElementById('comp-toggle').addEventListener('click', function(){
  document.getElementById('comp-panel').classList.toggle('open');
  document.getElementById('import-panel').classList.remove('open');
});

// Comp tabs
document.querySelectorAll('[data-ctab]').forEach(function(tab){
  tab.addEventListener('click', function(){
    document.querySelectorAll('[data-ctab]').forEach(function(t){ t.classList.remove('active'); });
    document.querySelectorAll('[id^="ctab-"]').forEach(function(c){ c.classList.remove('active'); });
    tab.classList.add('active');
    document.getElementById('ctab-'+tab.dataset.ctab).classList.add('active');
  });
});

// Paste import
document.getElementById('btn-comp-paste-imp').addEventListener('click', function(){
  var t = document.getElementById('comp-paste-input').value.trim();
  if(!t){ showCompMsg('Paste some data first.','err'); return; }
  var rows = t.split('\n').map(function(l){ return l.split('\t'); });
  var s = isCompHdr(rows[0]) ? 1 : 0;
  var n = importComps(rows.slice(s));
  if(n>0){ showCompMsg('‚úì Added '+n+' comp'+(n===1?'':'s')+'. Run Address Matching to link them.','ok'); document.getElementById('comp-paste-input').value=''; refreshAfterCompChange(); }
  else showCompMsg('No valid rows found. Check column order.','err');
});

// CSV import
var compCsvInput = document.getElementById('comp-csv-input');
var compFileDrop = document.getElementById('comp-file-drop');
compFileDrop.addEventListener('click', function(){ compCsvInput.click(); });
compFileDrop.addEventListener('dragover', function(e){ e.preventDefault(); compFileDrop.classList.add('dov'); });
compFileDrop.addEventListener('dragleave', function(){ compFileDrop.classList.remove('dov'); });
compFileDrop.addEventListener('drop', function(e){
  e.preventDefault(); compFileDrop.classList.remove('dov');
  if(e.dataTransfer.files[0]){ try{ var dt=new DataTransfer(); dt.items.add(e.dataTransfer.files[0]); compCsvInput.files=dt.files; }catch(err){}
  document.getElementById('comp-drop-lbl').textContent=e.dataTransfer.files[0].name; }
});
compCsvInput.addEventListener('change', function(){ if(compCsvInput.files[0]) document.getElementById('comp-drop-lbl').textContent=compCsvInput.files[0].name; });
document.getElementById('btn-comp-csv-imp').addEventListener('click', function(){
  var file = compCsvInput.files[0]; if(!file){ showCompMsg('Select a CSV file first.','err'); return; }
  var reader = new FileReader();
  reader.onload = function(e){
    var rows = e.target.result.split('\n').map(function(line){
      var res=[],cur='',inQ=false;
      for(var i=0;i<line.length;i++){var ch=line[i];if(ch==='"'){inQ=!inQ;}else if(ch===','&&!inQ){res.push(cur.trim());cur='';}else cur+=ch;}
      res.push(cur.trim()); return res;
    }).filter(function(r){ return r.some(function(c){ return c; }); });
    var s = isCompHdr(rows[0]) ? 1 : 0;
    var n = importComps(rows.slice(s));
    if(n>0){ showCompMsg('‚úì Added '+n+' comps from CSV.','ok'); document.getElementById('comp-drop-lbl').textContent='Drop CSV here or click to browse'; refreshAfterCompChange(); }
    else showCompMsg('No valid rows found.','err');
  };
  reader.readAsText(file);
});

// Manual entry
document.getElementById('btn-comp-manual-add').addEventListener('click', function(){
  var addr = document.getElementById('cm-address').value.trim();
  if(!addr){ showCompMsg('Address is required.','err'); return; }
  var rawDate = document.getElementById('cm-date').value;
  var c = {
    id: Date.now()+Math.random(),
    name: document.getElementById('cm-name').value.trim(),
    address: addr,
    price: parseFloat(document.getElementById('cm-price').value)||null,
    date: rawDate||'',
    units: parseInt(document.getElementById('cm-units').value)||null,
    sf: parseFloat(document.getElementById('cm-sf').value)||null,
    yearBuilt: parseInt(document.getElementById('cm-year').value)||null,
    bldgClass: document.getElementById('cm-class').value.trim(),
    capRate: parseFloat(document.getElementById('cm-cap').value)||null,
    pfCapRate: parseFloat(document.getElementById('cm-pfcap').value)||null,
    buyer: document.getElementById('cm-buyer').value.trim(),
    seller: document.getElementById('cm-seller').value.trim(),
    broker: document.getElementById('cm-broker').value.trim(),
    affType: document.getElementById('cm-aff').value.trim(),
    notes: document.getElementById('cm-notes').value.trim(),
    ppu: null, ppsf: null, vacancy:'',
    topaId: null
  };
  if(compsDupe(c)){ showCompMsg('Duplicate address + date already exists.','err'); return; }
  compsData.push(c);
  showCompMsg('‚úì Comp added. Run Address Matching to link it.','ok');
  // Clear form
  ['cm-address','cm-name','cm-price','cm-units','cm-sf','cm-year','cm-class','cm-cap','cm-pfcap','cm-buyer','cm-seller','cm-broker','cm-aff','cm-notes'].forEach(function(id){ document.getElementById(id).value=''; });
  document.getElementById('cm-date').value='';
  refreshAfterCompChange();
});

// JSON load
var compJsonInput = document.getElementById('comp-json-input');
var compJsonDrop = document.getElementById('comp-json-drop');
compJsonDrop.addEventListener('click', function(){ compJsonInput.click(); });
compJsonDrop.addEventListener('dragover', function(e){ e.preventDefault(); compJsonDrop.classList.add('dov'); });
compJsonDrop.addEventListener('dragleave', function(){ compJsonDrop.classList.remove('dov'); });
compJsonDrop.addEventListener('drop', function(e){
  e.preventDefault(); compJsonDrop.classList.remove('dov');
  if(e.dataTransfer.files[0]){ try{var dt=new DataTransfer();dt.items.add(e.dataTransfer.files[0]);compJsonInput.files=dt.files;}catch(err){} document.getElementById('comp-json-lbl').textContent=e.dataTransfer.files[0].name; }
});
compJsonInput.addEventListener('change', function(){ if(compJsonInput.files[0]) document.getElementById('comp-json-lbl').textContent=compJsonInput.files[0].name; });
document.getElementById('btn-comp-json-imp').addEventListener('click', function(){
  var file = compJsonInput.files[0]; if(!file){ showCompMsg('Select a JSON file first.','err'); return; }
  var reader = new FileReader();
  reader.onload = function(e){
    try{
      var data = JSON.parse(e.target.result);
      if(!Array.isArray(data)) throw new Error('not array');
      var n = 0;
      data.forEach(function(c){ if(c.address && !compsDupe(c)){ compsData.push(c); n++; } });
      showCompMsg('‚úì Loaded '+n+' comps from JSON ('+(data.length-n)+' dupes skipped).','ok');
      document.getElementById('comp-json-lbl').textContent='Drop sales_comps.json here or click to browse';
      refreshAfterCompChange();
    }catch(err){ showCompMsg('Invalid JSON file.','err'); }
  };
  reader.readAsText(file);
});

// Run matching button
document.getElementById('btn-run-matching').addEventListener('click', runMatching);

// Clear comps
document.getElementById('btn-clr-comps').addEventListener('click', function(){
  if(!compsData.length){ showCompMsg('No comps to clear.','err'); return; }
  if(!confirm('Clear all '+compsData.length+' sales comps? This cannot be undone.')) return;
  compsData = []; refreshAfterCompChange();
  showCompMsg('All comps cleared.','ok');
});

// ‚îÄ‚îÄ PROPERTIES IMPORT / CLEAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadPropertiesJson(file){
  var reader = new FileReader();
  reader.onload = function(e){
    try {
      var d = JSON.parse(e.target.result);
      if(!Array.isArray(d)) throw new Error('not an array');
      allData = d.map(function(p,i){ var o=Object.assign({},p); o._idx=i; return o; });
      // topaId references in compsData now point to new indexes ‚Äî clear comps to avoid bad links
      compsData = []; renderCompsSidebar();
      showCompMsg('‚úì Loaded '+allData.length+' properties. Comps cleared (re-import & re-match).','ok');
      applyFilters();
    } catch(err){ showCompMsg('Invalid properties JSON.','err'); }
  };
  reader.readAsText(file);
}
document.getElementById('props-json-input').addEventListener('change', function(){
  if(this.files[0]) loadPropertiesJson(this.files[0]);
});
document.getElementById('props-json-drop').addEventListener('click', function(){
  document.getElementById('props-json-input').click();
});
document.getElementById('props-json-drop').addEventListener('dragover', function(e){ e.preventDefault(); this.classList.add('drag-over'); });
document.getElementById('props-json-drop').addEventListener('dragleave', function(){ this.classList.remove('drag-over'); });
document.getElementById('props-json-drop').addEventListener('drop', function(e){
  e.preventDefault(); this.classList.remove('drag-over');
  var f = e.dataTransfer.files[0];
  if(f) loadPropertiesJson(f);
});
document.getElementById('btn-props-json-imp').addEventListener('click', function(){
  var f = document.getElementById('props-json-input').files[0];
  if(f) loadPropertiesJson(f); else showCompMsg('No file selected.','err');
});
document.getElementById('btn-clr-props').addEventListener('click', function(){
  if(!allData.length){ showCompMsg('No properties to clear.','err'); return; }
  if(!confirm('Clear all '+allData.length+' properties and comps? This cannot be undone.')) return;
  allData = []; compsData = []; renderCompsSidebar(); applyFilters();
  showCompMsg('All properties and comps cleared.','ok');
});

// ‚îÄ‚îÄ GITHUB SYNC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function(){
  var LS = 'topa_gh_';
  var dot = document.getElementById('gh-sync-dot');
  var btn = document.getElementById('gh-sync-btn');

  function getConf(){
    return {
      owner: localStorage.getItem(LS+'owner')||'',
      repo:  localStorage.getItem(LS+'repo')||'',
      branch:localStorage.getItem(LS+'branch')||'main',
      token: localStorage.getItem(LS+'token')||''
    };
  }

  function isConfigured(){
    var c=getConf(); return !!(c.owner && c.repo && c.token);
  }

  function updateDot(){
    dot.className = 'gh-sync-dot' + (isConfigured() ? ' configured' : '');
    btn.title = isConfigured()
      ? 'Save properties + comps to GitHub'
      : 'Click to configure GitHub sync';
  }
  updateDot();

  // Open modal on button click ‚Äî if not configured go straight to settings,
  // if configured ask whether to save or open settings
  btn.addEventListener('click', function(){
    if(!isConfigured()){
      openModal();
      return;
    }
    pushToGitHub();
  });

  // Long-press or right-click to open settings when already configured
  var pressTimer;
  btn.addEventListener('mousedown', function(){ pressTimer = setTimeout(openModal, 600); });
  btn.addEventListener('mouseup',   function(){ clearTimeout(pressTimer); });
  btn.addEventListener('mouseleave',function(){ clearTimeout(pressTimer); });
  btn.addEventListener('contextmenu',function(e){ e.preventDefault(); openModal(); });

  function openModal(){
    var c=getConf();
    document.getElementById('gh-owner').value  = c.owner;
    document.getElementById('gh-repo').value   = c.repo;
    document.getElementById('gh-branch').value = c.branch||'main';
    document.getElementById('gh-token').value  = c.token;
    document.getElementById('gh-modal-status').className='gh-status';
    document.getElementById('gh-modal-overlay').classList.add('open');
  }

  document.getElementById('gh-modal-cancel').addEventListener('click', function(){
    document.getElementById('gh-modal-overlay').classList.remove('open');
  });
  document.getElementById('gh-modal-overlay').addEventListener('click', function(e){
    if(e.target===this) this.classList.remove('open');
  });

  document.getElementById('gh-modal-save').addEventListener('click', function(){
    var owner  = document.getElementById('gh-owner').value.trim();
    var repo   = document.getElementById('gh-repo').value.trim();
    var branch = document.getElementById('gh-branch').value.trim()||'main';
    var token  = document.getElementById('gh-token').value.trim();
    var st = document.getElementById('gh-modal-status');
    if(!owner||!repo||!token){
      st.className='gh-status err'; st.textContent='All fields except Branch are required.'; return;
    }
    localStorage.setItem(LS+'owner',  owner);
    localStorage.setItem(LS+'repo',   repo);
    localStorage.setItem(LS+'branch', branch);
    localStorage.setItem(LS+'token',  token);
    st.className='gh-status ok'; st.textContent='Settings saved. Click "Save to GitHub" to sync.';
    updateDot();
    setTimeout(function(){ document.getElementById('gh-modal-overlay').classList.remove('open'); }, 1200);
  });

  // ‚îÄ‚îÄ Core push function ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function pushToGitHub(){
    if(!isConfigured()){ openModal(); return; }
    var c = getConf();
    btn.classList.add('syncing');
    btn.textContent = '‚Üë Saving‚Ä¶';

    try {
      // Geocode any properties not yet in GEO cache before saving so coords are baked in
      btn.innerHTML = '<span class="gh-sync-dot configured"></span> ‚Üë Geocoding‚Ä¶';
      var ungeocoded = allData.filter(function(p){ return !GEO[p.address]; });
      for(var gi=0; gi<ungeocoded.length; gi++){
        await geocode(ungeocoded[gi].address);
      }
      btn.innerHTML = '<span class="gh-sync-dot configured"></span> ‚Üë Saving‚Ä¶';
      var r1 = await pushFile(c, 'data/properties.json', buildPropsJson());
      if(!r1.ok){ showSyncToast('Error: ' + r1.msg, false); dot.className='gh-sync-dot error'; btn.classList.remove('syncing'); btn.innerHTML='<span class="gh-sync-dot configured"></span> ‚Üë Save to GitHub'; return; }
      var r2 = await pushFile(c, 'data/sales_comps.json', buildCompsJson());
      if(!r2.ok){ showSyncToast('Error: ' + r2.msg, false); dot.className='gh-sync-dot error'; btn.classList.remove('syncing'); btn.innerHTML='<span class="gh-sync-dot configured"></span> ‚Üë Save to GitHub'; return; }
      showSyncToast('‚úì Saved to GitHub ‚Äî users will see changes on next refresh.', true);
      dot.className = 'gh-sync-dot configured';
    } catch(err){
      showSyncToast('Error: ' + err.message, false);
      dot.className = 'gh-sync-dot error';
    }

    btn.classList.remove('syncing');
    btn.innerHTML = '<span class="gh-sync-dot'+(isConfigured()?' configured':'')+'"></span> ‚Üë Save to GitHub';
    dot = document.getElementById('gh-sync-dot'); // re-grab after innerHTML reset
  }

  async function pushFile(c, path, content){
    var base64 = btoa(unescape(encodeURIComponent(content)));
    var apiUrl = 'https://api.github.com/repos/'+c.owner+'/'+c.repo+'/contents/'+path;

    // Get current SHA (needed to update an existing file; skip if file doesn't exist yet)
    var sha = null;
    try {
      var getResp = await fetch(apiUrl+'?ref='+c.branch, {
        headers: { 'Authorization': 'Bearer '+c.token, 'Accept': 'application/vnd.github+json' }
      });
      if(getResp.ok){
        var existing = await getResp.json();
        sha = existing.sha;
      } else if(getResp.status !== 404){
        // Unexpected error on GET ‚Äî surface it
        return {ok:false, msg: path+' (GET '+getResp.status+'): check token permissions and repo name'};
      }
      // 404 = file doesn't exist yet, proceed with create (no sha needed)
    } catch(e){ /* network error ‚Äî try anyway */ }

    var body = { message: 'Update '+path+' via TOPA Dashboard', content: base64, branch: c.branch };
    if(sha) body.sha = sha;

    var putResp = await fetch(apiUrl, {
      method: 'PUT',
      headers: {
        'Authorization': 'Bearer '+c.token,
        'Accept': 'application/vnd.github+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });

    if(putResp.ok) return {ok:true};
    var errData = await putResp.json().catch(function(){ return {}; });
    return {ok:false, msg: path+' ('+putResp.status+'): '+(errData.message||'unknown error')+(errData.errors?(' ‚Äî '+JSON.stringify(errData.errors)):'')};
  }

  function buildPropsJson(){
    // Bake any cached coords into each property so they load instantly without Nominatim calls
    var clean = allData.map(function(p){
      var o=Object.assign({},p);
      delete o._idx; delete o._marker;
      if(!o._coords && GEO[p.address]) o._coords = GEO[p.address];
      return o;
    });
    return JSON.stringify(clean, null, 2);
  }

  function buildCompsJson(){
    return JSON.stringify(compsData, null, 2);
  }

  function showSyncToast(msg, success){
    var t = document.getElementById('gh-toast');
    if(!t){
      t = document.createElement('div');
      t.id = 'gh-toast';
      t.style.cssText = 'position:fixed;bottom:60px;left:50%;transform:translateX(-50%);z-index:3000;padding:10px 18px;border-radius:8px;font-size:0.72rem;font-weight:700;font-family:var(--font);box-shadow:0 4px 20px rgba(0,0,0,0.2);transition:opacity 0.3s;white-space:nowrap;';
      document.body.appendChild(t);
    }
    t.textContent = msg;
    t.style.background = success ? '#f0fdf4' : '#fef2f2';
    t.style.color = success ? '#15803d' : '#b91c1c';
    t.style.border = '1px solid ' + (success ? '#bbf7d0' : '#fecaca');
    t.style.opacity = '1';
    clearTimeout(t._hide);
    t._hide = setTimeout(function(){ t.style.opacity='0'; }, 4000);
  }
})();


document.addEventListener('DOMContentLoaded', function(){
  initMap();
  var bust = '?v=' + Date.now();
  // Load TOPA properties from data/properties.json, then load comps, then render
  fetch('data/properties.json' + bust, {cache: 'no-store'})
    .then(function(r){ if(!r.ok) throw new Error('no properties file'); return r.json(); })
    .then(function(d){
      if(Array.isArray(d) && d.length){
        allData = d.map(function(p,i){ var o=Object.assign({},p); o._idx=i; return o; });
        // Pre-populate GEO cache from baked coords so Nominatim isn't called for known properties
        allData.forEach(function(p){
          if(p._coords && !GEO[p.address]) GEO[p.address] = p._coords;
        });
      }
    })
    .catch(function(){ /* no properties file ‚Äî start empty */ })
    .finally(async function(){
      // Geocode any properties missing from GEO cache before first render
      var missing = allData.filter(function(p){ return !GEO[p.address]; });
      for(var i=0; i<missing.length; i++){
        await geocode(missing[i].address);
      }
      // Now load comps
      fetch('data/sales_comps.json' + bust, {cache: 'no-store'})
        .then(function(r){ if(!r.ok) throw new Error('no comps file'); return r.json(); })
        .then(function(d){
          if(Array.isArray(d) && d.length){
            d.forEach(function(c){ if(!compsDupe(c)) compsData.push(c); });
            renderCompsSidebar();
            showCompMsg('‚úì Loaded '+d.length+' comps from data/sales_comps.json','ok');
          }
        })
        .catch(function(){ /* no comps file ‚Äî that's fine */ })
        .finally(function(){
          applyFilters();
        });
    });
});
</script>
</body>
</html>
